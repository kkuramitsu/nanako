<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nanako Code Editor</title>
    <style>
        :root {
            /* Dark theme (default) */
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d30;
            --bg-tertiary: #252526;
            --text-primary: #d4d4d4;
            --text-secondary: #cccccc;
            --border-color: #3e3e42;
            --button-primary: #0e639c;
            --button-primary-hover: #1177bb;
            --button-secondary: #666;
            --button-secondary-hover: #777;
            --output-bg: #252526;
            --monaco-bg: #1e1e1e;
        }

        [data-theme="light"] {
            /* Light theme */
            --bg-primary: #ffffff;
            --bg-secondary: #f3f3f3;
            --bg-tertiary: #fafafa;
            --text-primary: #333333;
            --text-secondary: #555555;
            --border-color: #e1e1e1;
            --button-primary: #0066cc;
            --button-primary-hover: #0052a3;
            --button-secondary: #999999;
            --button-secondary-hover: #777777;
            --output-bg: #fafafa;
            --monaco-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background: var(--bg-secondary);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header h1 {
            margin: 0;
            font-size: 20px;
            color: var(--text-secondary);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .run-btn {
            background: var(--button-primary);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .run-btn:hover {
            background: var(--button-primary-hover);
        }
        
        .run-btn:disabled {
            background: var(--button-secondary);
            cursor: not-allowed;
        }
        
        .clear-btn {
            background: var(--button-secondary);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .clear-btn:hover {
            background: var(--button-secondary-hover);
        }
        
        .theme-btn {
            background: var(--button-secondary);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .theme-btn:hover {
            background: var(--button-secondary-hover);
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .editor-container {
            flex: 1;
            position: relative;
            border-right: 1px solid #3e3e42;
            min-height: 400px;
        }
        
        #editor {
            width: 100%;
            height: 100%;
        }
        
        .output-container {
            width: 50%;
            display: flex;
            flex-direction: column;
            background: var(--output-bg);
        }
        
        .tab-container {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-primary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab:hover {
            background: var(--bg-tertiary);
        }
        
        .tab.active {
            border-bottom-color: var(--button-primary);
            background: var(--bg-tertiary);
        }
        
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .generated-code {
            flex: 1;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-y: auto;
            white-space: pre;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
        }
        
        .output-header {
            background: var(--bg-secondary);
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .output {
            flex: 1;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-y: auto;
            white-space: pre-wrap;
            color: var(--text-primary);
        }
        
        .error {
            color: #f48771;
        }
        
        .success {
            color: #4fc1ff;
        }
        
        .variable-output {
            color: #9cdcfe;
        }
        
        .execution-info {
            color: #608b4e;
            font-size: 11px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #3e3e42;
        }
        
        .examples {
            margin-left: 20px;
        }
        
        .examples select {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .resize-handle {
            width: 4px;
            background: var(--border-color);
            cursor: ew-resize;
            user-select: none;
        }
        
        .resize-handle:hover {
            background: var(--button-primary);
        }
        
        .running {
            color: #4fc1ff;
        }
        
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: #4fc1ff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .run-btn.executing {
            background: var(--button-secondary);
            color: #ccc;
            cursor: wait;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Nanako (ななこ) Code Editor</h1>
        <div class="controls">
            <div class="examples">
                <label for="examples">例: </label>
                <select id="examples">
                    <option value="">選択してください</option>
                    <option value="mycode">🔄 マイコードに戻る</option>
                    <option value="01basic.nanako">基本操作</option>
                    <option value="02loop.nanako">ループ</option>
                    <option value="03function.nanako">関数</option>
                    <option value="04if.nanako">条件分岐</option>
                    <option value="gcd.nanako">最大公約数</option>
                    <option value="fibonacci.nanako">フィボナッチ</option>
                </select>
            </div>
            <button id="themeBtn" class="theme-btn">🌙</button>
            <button id="runBtn" class="run-btn">実行 (Ctrl+Enter)</button>
            <button id="clearBtn" class="clear-btn">クリア</button>
        </div>
    </div>
    
    <div class="main-content">
        <div class="editor-container">
            <div id="editor"></div>
        </div>
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="output-container" id="outputContainer">
            <div class="tab-container">
                <button class="tab active" data-tab="result">実行結果</button>
                <button class="tab" data-tab="javascript">JavaScript</button>
                <button class="tab" data-tab="python">Python</button>
            </div>
            
            <div id="result-tab" class="tab-content active">
                <div class="output-header">実行結果</div>
                <div id="output" class="output">コードを実行すると結果がここに表示されます。</div>
            </div>
            
            <div id="javascript-tab" class="tab-content">
                <div class="output-header">生成されたJavaScriptコード</div>
                <textarea id="javascript-output" class="generated-code" readonly>Nanakoコードを入力すると、JavaScriptコードが生成されます。</textarea>
            </div>
            
            <div id="python-tab" class="tab-content">
                <div class="output-header">生成されたPythonコード</div>
                <textarea id="python-output" class="generated-code" readonly>Nanakoコードを入力すると、Pythonコードが生成されます。</textarea>
            </div>
        </div>
    </div>

    <script src="nanako.js"></script>
    <script src="nanako_examples.js"></script>
    <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script>
        // Nanako runtime の読み込み確認
        console.log('NanakoRuntime available:', typeof NanakoRuntime !== 'undefined');
    </script>
    <script>
        let editor;
        let isResizing = false;
        
        // Monaco Editor の初期化
        require.config({ 
            paths: { 
                'vs': 'https://unpkg.com/monaco-editor@0.44.0/min/vs' 
            }
        });
        
        window.MonacoEnvironment = {
            getWorkerUrl: function (moduleId, label) {
                if (label === 'json') {
                    return 'https://unpkg.com/monaco-editor@0.44.0/min/vs/language/json/json.worker.js';
                }
                if (label === 'css') {
                    return 'https://unpkg.com/monaco-editor@0.44.0/min/vs/language/css/css.worker.js';
                }
                if (label === 'html') {
                    return 'https://unpkg.com/monaco-editor@0.44.0/min/vs/language/html/html.worker.js';
                }
                if (label === 'typescript' || label === 'javascript') {
                    return 'https://unpkg.com/monaco-editor@0.44.0/min/vs/language/typescript/ts.worker.js';
                }
                return 'https://unpkg.com/monaco-editor@0.44.0/min/vs/editor/editor.worker.js';
            }
        };
        
        require(['vs/editor/editor.main'], function () {
            try {
                // Nanako言語の定義
                monaco.languages.register({ id: 'nanako' });
                
                // Nanako用のシンタックスハイライト
                monaco.languages.setMonarchTokensProvider('nanako', {
                    tokenizer: {
                        root: [
                            [/＃.*$/, 'comment'],
                            [/#.*$/, 'comment'],
                            [/もし|ならば|そうでなければ/, 'keyword'],
                            [/くり返す|回/, 'keyword'],
                            [/を|が|に対して?|とする|が答え/, 'keyword'],
                            [/増やす|減らす/, 'keyword'],
                            [/以上|以下|より大きい|より小さい|以外|未満/, 'keyword'],
                            [/λ|入力/, 'keyword'],
                            [/null|？|\?/, 'constant'],
                            [/"([^"\\\\]|\\\\.)*"/, 'string'],
                            [/\d+/, 'number'],
                            [/[a-zA-Zあ-んア-ン一-龥_][a-zA-Zあ-んア-ン一-龥0-9_]*/, 'identifier'],
                            [/[{}()[\]]/, 'bracket'],
                            [/[=,、]/, 'operator'],
                            [/\|/, 'operator']
                        ]
                    }
                });
                
                // テーマの定義
                monaco.editor.defineTheme('nanako-dark', {
                    base: 'vs-dark',
                    inherit: true,
                    rules: [
                        { token: 'comment', foreground: '608b4e', fontStyle: 'italic' },
                        { token: 'keyword', foreground: 'c586c0' },
                        { token: 'string', foreground: 'ce9178' },
                        { token: 'number', foreground: 'b5cea8' },
                        { token: 'identifier', foreground: '9cdcfe' },
                        { token: 'operator', foreground: 'd4d4d4' },
                        { token: 'bracket', foreground: 'ffd700' }
                    ],
                    colors: {
                        'editor.background': '#1e1e1e',
                        'editor.foreground': '#d4d4d4'
                    }
                });
                
                editor = monaco.editor.create(document.getElementById('editor'), {
                    value: `# Nanako (ななこ) へようこそ！
# 基本的な操作例

x = 10
y = 5

# 値を増やす・減らす
xを増やす
yを減らす

# 結果: x = 11, y = 4`,
                    language: 'nanako',
                    theme: 'nanako-dark',
                    fontSize: 14,
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false,
                    automaticLayout: true,
                    readOnly: false, // 明示的に編集可能に設定
                    wordWrap: 'on'
                });
                
                // キーボードショートカット
                editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, function() {
                    runCode();
                });
                
                // 自動保存機能
                editor.onDidChangeModelContent(() => {
                    // デバウンス処理（連続変更時の負荷軽減）
                    clearTimeout(window.saveTimeout);
                    window.saveTimeout = setTimeout(() => {
                        saveMyCode();
                    }, 500);
                });
                
                // マイコードの復元（Monaco Editor初期化後）
                setTimeout(() => {
                    const savedCode = restoreMyCode();
                    if (savedCode && savedCode.trim() !== '') {
                        console.log('Restoring saved code...');
                        editor.setValue(savedCode);
                    }
                }, 100);
                
                console.log('Monaco Editor initialized successfully');
                console.log('Editor readOnly status:', editor.getOption(monaco.editor.EditorOption.readOnly));
                console.log('Editor current value length:', editor.getValue().length);
            } catch (error) {
                console.error('Monaco Editor initialization failed:', error);
                initFallbackEditor();
            }
        }, function(error) {
            console.error('Failed to load Monaco Editor:', error);
            initFallbackEditor();
        });
        
        // フォールバック用のシンプルなテキストエリア
        function initFallbackEditor() {
            const editorContainer = document.getElementById('editor');
            editorContainer.innerHTML = `
                <textarea id="fallback-editor" style="
                    width: 100%;
                    height: 100%;
                    background: #1e1e1e;
                    color: #d4d4d4;
                    border: none;
                    font-family: 'Consolas', 'Monaco', monospace;
                    font-size: 14px;
                    padding: 16px;
                    resize: none;
                    outline: none;
                    box-sizing: border-box;
                "># Nanako (ななこ) へようこそ！
# 基本的な操作例

x = 10
y = 5

# 値を増やす・減らす
xを増やす
yを減らす

# 結果: x = 11, y = 4</textarea>
            `;
            
            const textarea = document.getElementById('fallback-editor');
            textarea.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    runCode();
                }
            });
            
            // 自動保存機能
            textarea.addEventListener('input', function() {
                // デバウンス処理（連続変更時の負荷軽減）
                clearTimeout(window.saveTimeout);
                window.saveTimeout = setTimeout(() => {
                    saveMyCode();
                }, 500);
            });
            
            // editor オブジェクトのモック
            editor = {
                getValue: function() {
                    return textarea.value;
                },
                setValue: function(value) {
                    textarea.value = value;
                },
                layout: function() {
                    // no-op
                }
            };
            
            // マイコードの復元（Fallback Editor初期化後）
            setTimeout(() => {
                const savedCode = restoreMyCode();
                if (savedCode && savedCode.trim() !== '') {
                    console.log('Restoring saved code to fallback editor...');
                    textarea.value = savedCode;
                }
            }, 100);
            
            console.log('Fallback editor initialized');
        }
        
        // ユーザーのマイコード保存
        let myCode = '';
        
        // デバッグ用: localStorageクリア機能（URLパラメータで制御）
        if (window.location.search.includes('clear=1')) {
            console.log('Clearing localStorage...');
            localStorage.removeItem('nanako_mycode');
        }
        
        // example ファイル読み込み機能（JavaScript形式）
        function loadExampleFile(filename) {
            try {
                console.log(`Loading example file: ${filename}`);
                
                if (typeof window.NanakoExamples === 'undefined') {
                    throw new Error('NanakoExamples not loaded');
                }
                
                const example = window.getNanakoExample(filename);
                if (!example) {
                    throw new Error(`Example file ${filename} not found`);
                }
                
                console.log(`Successfully loaded: ${filename} (${example.title})`);
                return example.code;
                
            } catch (error) {
                console.error('Error loading example file:', error);
                return `# エラー: ${filename} を読み込めませんでした\n# ${error.message}`;
            }
        }
        
        // マイコードの保存
        function saveMyCode() {
            if (editor) {
                myCode = editor.getValue();
                localStorage.setItem('nanako_mycode', myCode);
            }
        }
        
        // マイコードの復元
        function restoreMyCode() {
            const saved = localStorage.getItem('nanako_mycode');
            console.log('Restoring myCode from localStorage:', saved ? saved.length + ' chars' : 'null');
            if (saved && saved.trim() !== '') {
                myCode = saved;
                return myCode;
            }
            return '';
        }
        
        // DOMが読み込まれた後にイベントリスナーを登録
        document.addEventListener('DOMContentLoaded', function() {
            // 例選択の処理
            const exampleSelect = document.getElementById('examples');
            if (exampleSelect) {
                exampleSelect.addEventListener('change', function(e) {
                    const selected = e.target.value;
                    if (!selected || !editor) return;
                    
                    if (selected === 'mycode') {
                        // マイコードに戻る
                        const myCodeContent = restoreMyCode();
                        editor.setValue(myCodeContent);
                        exampleSelect.value = ''; // 選択をリセット
                    } else {
                        // 現在のコードをマイコードとして保存
                        saveMyCode();
                        
                        // 例ファイルを読み込み
                        const content = loadExampleFile(selected);
                        editor.setValue(content);
                        exampleSelect.value = ''; // 選択をリセット
                    }
                });
            }
            
            // テーマ切り替えボタン
            const themeBtn = document.getElementById('themeBtn');
            if (themeBtn) {
                themeBtn.addEventListener('click', toggleTheme);
            }
            
            // 実行ボタン
            const runBtn = document.getElementById('runBtn');
            if (runBtn) {
                runBtn.addEventListener('click', runCode);
            }
            
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearOutput);
            }
            
            // 初期テーマ設定
            initTheme();
            
            // タブ切り替え機能
            initTabs();
            
            // マイコードの復元（初回読み込み時）
            // この処理はMocaco Editor/Fallback Editor初期化の中で実行
        });
        
        function runCode() {
            if (!editor) {
                console.error('Editor not initialized');
                return;
            }
            
            const code = editor.getValue();
            const output = document.getElementById('output');
            const runBtn = document.getElementById('runBtn');
            
            if (!code || code.trim() === '') {
                output.innerHTML = '<div class="error">❌ コードが空です</div>';
                return;
            }
            
            // 即座に実行状態を表示
            if (runBtn) {
                runBtn.disabled = true;
                runBtn.classList.add('executing');
                runBtn.innerHTML = '実行中...';
            }
            
            // 出力をクリアして実行中メッセージを表示
            output.innerHTML = '<div class="running"><span class="spinner"></span>実行中...</div>';
            
            // エラーハイライトをクリア
            clearErrorHighlight();
            
            // 非同期で実行（UIをブロックしないため）
            setTimeout(() => {
                executeCode(code, output, runBtn);
            }, 10);
        }
        
        function executeCode(code, output, runBtn) {
            try {
                if (typeof NanakoRuntime === 'undefined') {
                    throw new Error('Nanako runtime not loaded');
                }
                
                const runtime = new NanakoRuntime();
                const startTime = Date.now();
                
                console.log('Executing code:', code);
                const env = runtime.exec(code, {}, 10); // 10秒のタイムアウト
                
                const endTime = Date.now();
                const executionTime = endTime - startTime;
                
                // 実行成功
                output.innerHTML = '<div class="success">✅ 実行成功</div>\n\n';
                
                // 変数の値を表示
                output.innerHTML += '<div class="variable-output">変数の状態:\n';
                const sortedVars = Object.keys(env).sort();
                if (sortedVars.length === 0) {
                    output.innerHTML += '  (変数が定義されていません)\n';
                } else {
                    sortedVars.forEach(key => {
                        const value = env[key];
                        let displayValue;
                        if (Array.isArray(value)) {
                            if (value.every(v => typeof v === 'number' && v >= 0 && v <= 127)) {
                                // 文字コード配列の場合、文字列として表示
                                const str = String.fromCharCode(...value);
                                displayValue = `"${str}" (文字コード配列: [${value.join(', ')}])`;
                            } else {
                                displayValue = JSON.stringify(value);
                            }
                        } else if (typeof value === 'object' && value && value.parameters) {
                            displayValue = `[関数: ${value.parameters.join(', ')}]`;
                        } else {
                            displayValue = JSON.stringify(value);
                        }
                        output.innerHTML += `  ${key} = ${displayValue}\n`;
                    });
                }
                output.innerHTML += '</div>\n';
                
                // 実行統計
                output.innerHTML += `<div class="execution-info">
実行統計:
  増やす回数: ${runtime.incrementCount}
  減らす回数: ${runtime.decrementCount}
  比較回数: ${runtime.compareCount}
  実行時間: ${executionTime}ms
</div>`;
                
            } catch (error) {
                // エラー処理
                output.innerHTML = `<div class="error">❌ エラー: ${error.message}</div>\n`;
                
                let errorLine = null;
                let errorCol = null;
                
                if (error.details) {
                    errorLine = error.details.line;
                    errorCol = error.details.col;
                    output.innerHTML += `<div class="error">
位置: 行 ${errorLine}, 列 ${errorCol}
コード: ${error.details.lineText}
</div>`;
                    
                    // エディターでエラー行をハイライト
                    highlightErrorInEditor(errorLine, errorCol, error.message);
                }
                
                console.error('Nanako execution error:', error);
            } finally {
                // 実行完了時にボタンを元に戻す
                if (runBtn) {
                    runBtn.disabled = false;
                    runBtn.classList.remove('executing');
                    runBtn.innerHTML = '実行 (Ctrl+Enter)';
                }
            }
        }

        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
        }

        function switchTab(tabName) {
            // タブボタンのアクティブ状態を更新
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                }
            });

            // タブコンテンツの表示を更新
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // JavaScriptまたはPythonタブが選択された場合、コード生成
            if (tabName === 'javascript' || tabName === 'python') {
                generateCode();
            }
        }

        function generateCode() {
            if (!editor) return;
            
            const code = editor.getValue();
            if (!code || code.trim() === '') {
                document.getElementById('javascript-output').value = 'コードが空です';
                document.getElementById('python-output').value = 'コードが空です';
                return;
            }

            try {
                const parser = new NanakoParser();
                const program = parser.parse(code);
                
                // JavaScriptコード生成
                const jsCode = program.emit('js');
                document.getElementById('javascript-output').value = jsCode;
                
                // Pythonコード生成
                const pyCode = program.emit('py');
                document.getElementById('python-output').value = pyCode;
                
            } catch (error) {
                const errorMsg = `# コード生成エラー: ${error.message}`;
                document.getElementById('javascript-output').value = errorMsg;
                document.getElementById('python-output').value = errorMsg;
            }
        }
        
        function clearOutput() {
            const output = document.getElementById('output');
            output.innerHTML = 'コードを実行すると結果がここに表示されます。';
            
            // エラーハイライトをクリア
            clearErrorHighlight();
        }

        function initTheme() {
            // 保存されたテーマを読み込む、なければダーク
            const savedTheme = localStorage.getItem('nanako-theme') || 'dark';
            setTheme(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        function setTheme(theme) {
            const themeBtn = document.getElementById('themeBtn');
            
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                if (themeBtn) themeBtn.textContent = '🌞';
            } else {
                document.documentElement.removeAttribute('data-theme');
                if (themeBtn) themeBtn.textContent = '🌙';
            }
            
            // Monaco Editorのテーマも更新
            updateMonacoTheme(theme);
            
            // フォールバックエディターのスタイルも更新
            updateFallbackEditorTheme(theme);
            
            // テーマを保存
            localStorage.setItem('nanako-theme', theme);
        }

        function updateMonacoTheme(theme) {
            if (editor && editor.updateOptions) {
                try {
                    if (theme === 'light') {
                        monaco.editor.setTheme('vs');
                    } else {
                        monaco.editor.setTheme('nanako-dark');
                    }
                } catch (e) {
                    console.log('Monaco theme update failed:', e);
                }
            }
        }

        function updateFallbackEditorTheme(theme) {
            const textarea = document.getElementById('fallback-editor');
            if (textarea) {
                if (theme === 'light') {
                    textarea.style.background = '#ffffff';
                    textarea.style.color = '#333333';
                } else {
                    textarea.style.background = '#1e1e1e';
                    textarea.style.color = '#d4d4d4';
                }
            }
        }
        
        // エディターでエラー箇所をハイライトする関数
        function highlightErrorInEditor(line, col, message) {
            if (!editor) return;
            
            try {
                if (editor.getModel) {
                    // Monaco Editor の場合
                    const model = editor.getModel();
                    if (model) {
                        // エラーマーカーを設定
                        monaco.editor.setModelMarkers(model, 'nanako-error', [{
                            startLineNumber: line,
                            startColumn: Math.max(1, col - 1),
                            endLineNumber: line,
                            endColumn: col + 10, // エラー範囲を少し広めに
                            message: message,
                            severity: monaco.MarkerSeverity.Error
                        }]);
                        
                        // エラー行にカーソルを移動
                        editor.setPosition({ lineNumber: line, column: col });
                        editor.revealLineInCenter(line);
                    }
                } else {
                    // フォールバックエディターの場合
                    const textarea = document.getElementById('fallback-editor');
                    if (textarea) {
                        // 行数を計算してカーソルを移動
                        const lines = textarea.value.split('\n');
                        let charPos = 0;
                        for (let i = 0; i < line - 1 && i < lines.length; i++) {
                            charPos += lines[i].length + 1; // +1 for newline
                        }
                        charPos += Math.max(0, col - 1);
                        
                        textarea.focus();
                        textarea.setSelectionRange(charPos, charPos + 10);
                    }
                }
            } catch (e) {
                console.error('Error highlighting failed:', e);
            }
        }
        
        // エラーハイライトをクリア
        function clearErrorHighlight() {
            if (!editor) return;
            
            try {
                if (editor.getModel) {
                    // Monaco Editor のマーカーをクリア
                    const model = editor.getModel();
                    if (model) {
                        monaco.editor.setModelMarkers(model, 'nanako-error', []);
                    }
                }
                // フォールバックエディターの場合は特に何もしない
            } catch (e) {
                console.error('Error clearing highlight failed:', e);
            }
        }
        
        // リサイズ機能
        const resizeHandle = document.getElementById('resizeHandle');
        const outputContainer = document.getElementById('outputContainer');
        
        resizeHandle.addEventListener('mousedown', function(e) {
            isResizing = true;
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault();
        });
        
        function handleResize(e) {
            if (!isResizing) return;
            const containerRect = document.querySelector('.main-content').getBoundingClientRect();
            const newWidth = containerRect.right - e.clientX;
            const minWidth = 200;
            const maxWidth = containerRect.width - 200;
            
            if (newWidth >= minWidth && newWidth <= maxWidth) {
                outputContainer.style.width = newWidth + 'px';
            }
        }
        
        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }
        
        // ウィンドウリサイズ時のエディターサイズ調整
        window.addEventListener('resize', function() {
            if (editor) {
                editor.layout();
            }
        });
    </script>
</body>
</html>