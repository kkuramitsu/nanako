<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nanako Code Editor</title>
    <style>
        :root {
            /* Dark theme (default) */
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d30;
            --bg-tertiary: #252526;
            --text-primary: #d4d4d4;
            --text-secondary: #cccccc;
            --border-color: #3e3e42;
            --button-primary: #0e639c;
            --button-primary-hover: #1177bb;
            --button-secondary: #666;
            --button-secondary-hover: #777;
            --output-bg: #252526;
            --monaco-bg: #1e1e1e;
        }

        [data-theme="light"] {
            /* Light theme */
            --bg-primary: #ffffff;
            --bg-secondary: #f3f3f3;
            --bg-tertiary: #fafafa;
            --text-primary: #333333;
            --text-secondary: #555555;
            --border-color: #e1e1e1;
            --button-primary: #0066cc;
            --button-primary-hover: #0052a3;
            --button-secondary: #999999;
            --button-secondary-hover: #777777;
            --output-bg: #fafafa;
            --monaco-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background: var(--bg-secondary);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header h1 {
            margin: 0;
            font-size: 20px;
            color: var(--text-secondary);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .run-btn {
            background: var(--button-primary);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .run-btn:hover {
            background: var(--button-primary-hover);
        }
        
        .run-btn:disabled {
            background: var(--button-secondary);
            cursor: not-allowed;
        }
        
        .clear-btn {
            background: var(--button-secondary);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .clear-btn:hover {
            background: var(--button-secondary-hover);
        }
        
        .theme-btn {
            background: var(--button-secondary);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .theme-btn:hover {
            background: var(--button-secondary-hover);
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .editor-container {
            flex: 1;
            position: relative;
            border-right: 1px solid #3e3e42;
            min-height: 400px;
        }
        
        #editor {
            width: 100%;
            height: 100%;
        }
        
        .output-container {
            width: 50%;
            display: flex;
            flex-direction: column;
            background: var(--output-bg);
        }
        
        .tab-container {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-primary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab:hover {
            background: var(--bg-tertiary);
        }
        
        .tab.active {
            border-bottom-color: var(--button-primary);
            background: var(--bg-tertiary);
        }
        
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .generated-code {
            flex: 1;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-y: auto;
            white-space: pre;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
        }
        
        .output-header {
            background: var(--bg-secondary);
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .output {
            flex: 1;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-y: auto;
            white-space: pre-wrap;
            color: var(--text-primary);
        }
        
        .error {
            color: #f48771;
        }
        
        .success {
            color: #4fc1ff;
        }
        
        .variable-output {
            color: #9cdcfe;
        }
        
        .execution-info {
            color: #608b4e;
            font-size: 11px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #3e3e42;
        }
        
        .examples {
            margin-left: 20px;
        }
        
        .examples select {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .resize-handle {
            width: 4px;
            background: var(--border-color);
            cursor: ew-resize;
            user-select: none;
        }
        
        .resize-handle:hover {
            background: var(--button-primary);
        }
        
        .running {
            color: #4fc1ff;
        }
        
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: #4fc1ff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .run-btn.executing {
            background: var(--button-secondary);
            color: #ccc;
            cursor: wait;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Nanako (ãªãªã“) Code Editor</h1>
        <div class="controls">
            <div class="examples">
                <label for="examples">ä¾‹: </label>
                <select id="examples">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="mycode">ğŸ”„ ãƒã‚¤ã‚³ãƒ¼ãƒ‰ã«æˆ»ã‚‹</option>
                    <option value="01basic.nanako">åŸºæœ¬æ“ä½œ</option>
                    <option value="02loop.nanako">ãƒ«ãƒ¼ãƒ—</option>
                    <option value="03function.nanako">é–¢æ•°</option>
                    <option value="04if.nanako">æ¡ä»¶åˆ†å²</option>
                    <option value="gcd.nanako">æœ€å¤§å…¬ç´„æ•°</option>
                    <option value="fibonacci.nanako">ãƒ•ã‚£ãƒœãƒŠãƒƒãƒ</option>
                </select>
            </div>
            <button id="themeBtn" class="theme-btn">ğŸŒ™</button>
            <button id="runBtn" class="run-btn">å®Ÿè¡Œ (Ctrl+Enter)</button>
            <button id="clearBtn" class="clear-btn">ã‚¯ãƒªã‚¢</button>
        </div>
    </div>
    
    <div class="main-content">
        <div class="editor-container">
            <div id="editor"></div>
        </div>
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="output-container" id="outputContainer">
            <div class="tab-container">
                <button class="tab active" data-tab="result">å®Ÿè¡Œçµæœ</button>
                <button class="tab" data-tab="javascript">JavaScript</button>
                <button class="tab" data-tab="python">Python</button>
            </div>
            
            <div id="result-tab" class="tab-content active">
                <div class="output-header">å®Ÿè¡Œçµæœ</div>
                <div id="output" class="output">ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
            </div>
            
            <div id="javascript-tab" class="tab-content">
                <div class="output-header">ç”Ÿæˆã•ã‚ŒãŸJavaScriptã‚³ãƒ¼ãƒ‰</div>
                <textarea id="javascript-output" class="generated-code" readonly>Nanakoã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€JavaScriptã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚</textarea>
            </div>
            
            <div id="python-tab" class="tab-content">
                <div class="output-header">ç”Ÿæˆã•ã‚ŒãŸPythonã‚³ãƒ¼ãƒ‰</div>
                <textarea id="python-output" class="generated-code" readonly>Nanakoã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€Pythonã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚</textarea>
            </div>
        </div>
    </div>

    <script src="nanako.js"></script>
    <script src="nanako_examples.js"></script>
    <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script>
        // Nanako runtime ã®èª­ã¿è¾¼ã¿ç¢ºèª
        console.log('NanakoRuntime available:', typeof NanakoRuntime !== 'undefined');
    </script>
    <script>
        let editor;
        let isResizing = false;
        
        // Monaco Editor ã®åˆæœŸåŒ–
        require.config({ 
            paths: { 
                'vs': 'https://unpkg.com/monaco-editor@0.44.0/min/vs' 
            }
        });
        
        window.MonacoEnvironment = {
            getWorkerUrl: function (moduleId, label) {
                if (label === 'json') {
                    return 'https://unpkg.com/monaco-editor@0.44.0/min/vs/language/json/json.worker.js';
                }
                if (label === 'css') {
                    return 'https://unpkg.com/monaco-editor@0.44.0/min/vs/language/css/css.worker.js';
                }
                if (label === 'html') {
                    return 'https://unpkg.com/monaco-editor@0.44.0/min/vs/language/html/html.worker.js';
                }
                if (label === 'typescript' || label === 'javascript') {
                    return 'https://unpkg.com/monaco-editor@0.44.0/min/vs/language/typescript/ts.worker.js';
                }
                return 'https://unpkg.com/monaco-editor@0.44.0/min/vs/editor/editor.worker.js';
            }
        };
        
        require(['vs/editor/editor.main'], function () {
            try {
                // Nanakoè¨€èªã®å®šç¾©
                monaco.languages.register({ id: 'nanako' });
                
                // Nanakoç”¨ã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                monaco.languages.setMonarchTokensProvider('nanako', {
                    tokenizer: {
                        root: [
                            [/ï¼ƒ.*$/, 'comment'],
                            [/#.*$/, 'comment'],
                            [/ã‚‚ã—|ãªã‚‰ã°|ãã†ã§ãªã‘ã‚Œã°/, 'keyword'],
                            [/ãã‚Šè¿”ã™|å›/, 'keyword'],
                            [/ã‚’|ãŒ|ã«å¯¾ã—ã¦?|ã¨ã™ã‚‹|ãŒç­”ãˆ/, 'keyword'],
                            [/å¢—ã‚„ã™|æ¸›ã‚‰ã™/, 'keyword'],
                            [/ä»¥ä¸Š|ä»¥ä¸‹|ã‚ˆã‚Šå¤§ãã„|ã‚ˆã‚Šå°ã•ã„|ä»¥å¤–|æœªæº€/, 'keyword'],
                            [/Î»|å…¥åŠ›/, 'keyword'],
                            [/null|ï¼Ÿ|\?/, 'constant'],
                            [/"([^"\\\\]|\\\\.)*"/, 'string'],
                            [/\d+/, 'number'],
                            [/[a-zA-Zã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾¥_][a-zA-Zã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾¥0-9_]*/, 'identifier'],
                            [/[{}()[\]]/, 'bracket'],
                            [/[=,ã€]/, 'operator'],
                            [/\|/, 'operator']
                        ]
                    }
                });
                
                // ãƒ†ãƒ¼ãƒã®å®šç¾©
                monaco.editor.defineTheme('nanako-dark', {
                    base: 'vs-dark',
                    inherit: true,
                    rules: [
                        { token: 'comment', foreground: '608b4e', fontStyle: 'italic' },
                        { token: 'keyword', foreground: 'c586c0' },
                        { token: 'string', foreground: 'ce9178' },
                        { token: 'number', foreground: 'b5cea8' },
                        { token: 'identifier', foreground: '9cdcfe' },
                        { token: 'operator', foreground: 'd4d4d4' },
                        { token: 'bracket', foreground: 'ffd700' }
                    ],
                    colors: {
                        'editor.background': '#1e1e1e',
                        'editor.foreground': '#d4d4d4'
                    }
                });
                
                editor = monaco.editor.create(document.getElementById('editor'), {
                    value: `# Nanako (ãªãªã“) ã¸ã‚ˆã†ã“ãï¼
# åŸºæœ¬çš„ãªæ“ä½œä¾‹

x = 10
y = 5

# å€¤ã‚’å¢—ã‚„ã™ãƒ»æ¸›ã‚‰ã™
xã‚’å¢—ã‚„ã™
yã‚’æ¸›ã‚‰ã™

# çµæœ: x = 11, y = 4`,
                    language: 'nanako',
                    theme: 'nanako-dark',
                    fontSize: 14,
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false,
                    automaticLayout: true,
                    readOnly: false, // æ˜ç¤ºçš„ã«ç·¨é›†å¯èƒ½ã«è¨­å®š
                    wordWrap: 'on'
                });
                
                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
                editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, function() {
                    runCode();
                });
                
                // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½
                editor.onDidChangeModelContent(() => {
                    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆé€£ç¶šå¤‰æ›´æ™‚ã®è² è·è»½æ¸›ï¼‰
                    clearTimeout(window.saveTimeout);
                    window.saveTimeout = setTimeout(() => {
                        saveMyCode();
                    }, 500);
                });
                
                // ãƒã‚¤ã‚³ãƒ¼ãƒ‰ã®å¾©å…ƒï¼ˆMonaco EditoråˆæœŸåŒ–å¾Œï¼‰
                setTimeout(() => {
                    const savedCode = restoreMyCode();
                    if (savedCode && savedCode.trim() !== '') {
                        console.log('Restoring saved code...');
                        editor.setValue(savedCode);
                    }
                }, 100);
                
                console.log('Monaco Editor initialized successfully');
                console.log('Editor readOnly status:', editor.getOption(monaco.editor.EditorOption.readOnly));
                console.log('Editor current value length:', editor.getValue().length);
            } catch (error) {
                console.error('Monaco Editor initialization failed:', error);
                initFallbackEditor();
            }
        }, function(error) {
            console.error('Failed to load Monaco Editor:', error);
            initFallbackEditor();
        });
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
        function initFallbackEditor() {
            const editorContainer = document.getElementById('editor');
            editorContainer.innerHTML = `
                <textarea id="fallback-editor" style="
                    width: 100%;
                    height: 100%;
                    background: #1e1e1e;
                    color: #d4d4d4;
                    border: none;
                    font-family: 'Consolas', 'Monaco', monospace;
                    font-size: 14px;
                    padding: 16px;
                    resize: none;
                    outline: none;
                    box-sizing: border-box;
                "># Nanako (ãªãªã“) ã¸ã‚ˆã†ã“ãï¼
# åŸºæœ¬çš„ãªæ“ä½œä¾‹

x = 10
y = 5

# å€¤ã‚’å¢—ã‚„ã™ãƒ»æ¸›ã‚‰ã™
xã‚’å¢—ã‚„ã™
yã‚’æ¸›ã‚‰ã™

# çµæœ: x = 11, y = 4</textarea>
            `;
            
            const textarea = document.getElementById('fallback-editor');
            textarea.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    runCode();
                }
            });
            
            // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½
            textarea.addEventListener('input', function() {
                // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆé€£ç¶šå¤‰æ›´æ™‚ã®è² è·è»½æ¸›ï¼‰
                clearTimeout(window.saveTimeout);
                window.saveTimeout = setTimeout(() => {
                    saveMyCode();
                }, 500);
            });
            
            // editor ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¢ãƒƒã‚¯
            editor = {
                getValue: function() {
                    return textarea.value;
                },
                setValue: function(value) {
                    textarea.value = value;
                },
                layout: function() {
                    // no-op
                }
            };
            
            // ãƒã‚¤ã‚³ãƒ¼ãƒ‰ã®å¾©å…ƒï¼ˆFallback EditoråˆæœŸåŒ–å¾Œï¼‰
            setTimeout(() => {
                const savedCode = restoreMyCode();
                if (savedCode && savedCode.trim() !== '') {
                    console.log('Restoring saved code to fallback editor...');
                    textarea.value = savedCode;
                }
            }, 100);
            
            console.log('Fallback editor initialized');
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¤ã‚³ãƒ¼ãƒ‰ä¿å­˜
        let myCode = '';
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨: localStorageã‚¯ãƒªã‚¢æ©Ÿèƒ½ï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§åˆ¶å¾¡ï¼‰
        if (window.location.search.includes('clear=1')) {
            console.log('Clearing localStorage...');
            localStorage.removeItem('nanako_mycode');
        }
        
        // example ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æ©Ÿèƒ½ï¼ˆJavaScriptå½¢å¼ï¼‰
        function loadExampleFile(filename) {
            try {
                console.log(`Loading example file: ${filename}`);
                
                if (typeof window.NanakoExamples === 'undefined') {
                    throw new Error('NanakoExamples not loaded');
                }
                
                const example = window.getNanakoExample(filename);
                if (!example) {
                    throw new Error(`Example file ${filename} not found`);
                }
                
                console.log(`Successfully loaded: ${filename} (${example.title})`);
                return example.code;
                
            } catch (error) {
                console.error('Error loading example file:', error);
                return `# ã‚¨ãƒ©ãƒ¼: ${filename} ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ\n# ${error.message}`;
            }
        }
        
        // ãƒã‚¤ã‚³ãƒ¼ãƒ‰ã®ä¿å­˜
        function saveMyCode() {
            if (editor) {
                myCode = editor.getValue();
                localStorage.setItem('nanako_mycode', myCode);
            }
        }
        
        // ãƒã‚¤ã‚³ãƒ¼ãƒ‰ã®å¾©å…ƒ
        function restoreMyCode() {
            const saved = localStorage.getItem('nanako_mycode');
            console.log('Restoring myCode from localStorage:', saved ? saved.length + ' chars' : 'null');
            if (saved && saved.trim() !== '') {
                myCode = saved;
                return myCode;
            }
            return '';
        }
        
        // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
        document.addEventListener('DOMContentLoaded', function() {
            // ä¾‹é¸æŠã®å‡¦ç†
            const exampleSelect = document.getElementById('examples');
            if (exampleSelect) {
                exampleSelect.addEventListener('change', function(e) {
                    const selected = e.target.value;
                    if (!selected || !editor) return;
                    
                    if (selected === 'mycode') {
                        // ãƒã‚¤ã‚³ãƒ¼ãƒ‰ã«æˆ»ã‚‹
                        const myCodeContent = restoreMyCode();
                        editor.setValue(myCodeContent);
                        exampleSelect.value = ''; // é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                    } else {
                        // ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚¤ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ä¿å­˜
                        saveMyCode();
                        
                        // ä¾‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
                        const content = loadExampleFile(selected);
                        editor.setValue(content);
                        exampleSelect.value = ''; // é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                    }
                });
            }
            
            // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
            const themeBtn = document.getElementById('themeBtn');
            if (themeBtn) {
                themeBtn.addEventListener('click', toggleTheme);
            }
            
            // å®Ÿè¡Œãƒœã‚¿ãƒ³
            const runBtn = document.getElementById('runBtn');
            if (runBtn) {
                runBtn.addEventListener('click', runCode);
            }
            
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearOutput);
            }
            
            // åˆæœŸãƒ†ãƒ¼ãƒè¨­å®š
            initTheme();
            
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
            initTabs();
            
            // ãƒã‚¤ã‚³ãƒ¼ãƒ‰ã®å¾©å…ƒï¼ˆåˆå›èª­ã¿è¾¼ã¿æ™‚ï¼‰
            // ã“ã®å‡¦ç†ã¯Mocaco Editor/Fallback EditoråˆæœŸåŒ–ã®ä¸­ã§å®Ÿè¡Œ
        });
        
        function runCode() {
            if (!editor) {
                console.error('Editor not initialized');
                return;
            }
            
            const code = editor.getValue();
            const output = document.getElementById('output');
            const runBtn = document.getElementById('runBtn');
            
            if (!code || code.trim() === '') {
                output.innerHTML = '<div class="error">âŒ ã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™</div>';
                return;
            }
            
            // å³åº§ã«å®Ÿè¡ŒçŠ¶æ…‹ã‚’è¡¨ç¤º
            if (runBtn) {
                runBtn.disabled = true;
                runBtn.classList.add('executing');
                runBtn.innerHTML = 'å®Ÿè¡Œä¸­...';
            }
            
            // å‡ºåŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¦å®Ÿè¡Œä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            output.innerHTML = '<div class="running"><span class="spinner"></span>å®Ÿè¡Œä¸­...</div>';
            
            // ã‚¨ãƒ©ãƒ¼ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢
            clearErrorHighlight();
            
            // éåŒæœŸã§å®Ÿè¡Œï¼ˆUIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ãŸã‚ï¼‰
            setTimeout(() => {
                executeCode(code, output, runBtn);
            }, 10);
        }
        
        function executeCode(code, output, runBtn) {
            try {
                if (typeof NanakoRuntime === 'undefined') {
                    throw new Error('Nanako runtime not loaded');
                }
                
                const runtime = new NanakoRuntime();
                const startTime = Date.now();
                
                console.log('Executing code:', code);
                const env = runtime.exec(code, {}, 10); // 10ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                
                const endTime = Date.now();
                const executionTime = endTime - startTime;
                
                // å®Ÿè¡ŒæˆåŠŸ
                output.innerHTML = '<div class="success">âœ… å®Ÿè¡ŒæˆåŠŸ</div>\n\n';
                
                // å¤‰æ•°ã®å€¤ã‚’è¡¨ç¤º
                output.innerHTML += '<div class="variable-output">å¤‰æ•°ã®çŠ¶æ…‹:\n';
                const sortedVars = Object.keys(env).sort();
                if (sortedVars.length === 0) {
                    output.innerHTML += '  (å¤‰æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“)\n';
                } else {
                    sortedVars.forEach(key => {
                        const value = env[key];
                        let displayValue;
                        if (Array.isArray(value)) {
                            if (value.every(v => typeof v === 'number' && v >= 0 && v <= 127)) {
                                // æ–‡å­—ã‚³ãƒ¼ãƒ‰é…åˆ—ã®å ´åˆã€æ–‡å­—åˆ—ã¨ã—ã¦è¡¨ç¤º
                                const str = String.fromCharCode(...value);
                                displayValue = `"${str}" (æ–‡å­—ã‚³ãƒ¼ãƒ‰é…åˆ—: [${value.join(', ')}])`;
                            } else {
                                displayValue = JSON.stringify(value);
                            }
                        } else if (typeof value === 'object' && value && value.parameters) {
                            displayValue = `[é–¢æ•°: ${value.parameters.join(', ')}]`;
                        } else {
                            displayValue = JSON.stringify(value);
                        }
                        output.innerHTML += `  ${key} = ${displayValue}\n`;
                    });
                }
                output.innerHTML += '</div>\n';
                
                // å®Ÿè¡Œçµ±è¨ˆ
                output.innerHTML += `<div class="execution-info">
å®Ÿè¡Œçµ±è¨ˆ:
  å¢—ã‚„ã™å›æ•°: ${runtime.incrementCount}
  æ¸›ã‚‰ã™å›æ•°: ${runtime.decrementCount}
  æ¯”è¼ƒå›æ•°: ${runtime.compareCount}
  å®Ÿè¡Œæ™‚é–“: ${executionTime}ms
</div>`;
                
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼å‡¦ç†
                output.innerHTML = `<div class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>\n`;
                
                let errorLine = null;
                let errorCol = null;
                
                if (error.details) {
                    errorLine = error.details.line;
                    errorCol = error.details.col;
                    output.innerHTML += `<div class="error">
ä½ç½®: è¡Œ ${errorLine}, åˆ— ${errorCol}
ã‚³ãƒ¼ãƒ‰: ${error.details.lineText}
</div>`;
                    
                    // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ã‚¨ãƒ©ãƒ¼è¡Œã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    highlightErrorInEditor(errorLine, errorCol, error.message);
                }
                
                console.error('Nanako execution error:', error);
            } finally {
                // å®Ÿè¡Œå®Œäº†æ™‚ã«ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                if (runBtn) {
                    runBtn.disabled = false;
                    runBtn.classList.remove('executing');
                    runBtn.innerHTML = 'å®Ÿè¡Œ (Ctrl+Enter)';
                }
            }
        }

        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
        }

        function switchTab(tabName) {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                }
            });

            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’æ›´æ–°
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // JavaScriptã¾ãŸã¯Pythonã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
            if (tabName === 'javascript' || tabName === 'python') {
                generateCode();
            }
        }

        function generateCode() {
            if (!editor) return;
            
            const code = editor.getValue();
            if (!code || code.trim() === '') {
                document.getElementById('javascript-output').value = 'ã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™';
                document.getElementById('python-output').value = 'ã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™';
                return;
            }

            try {
                const parser = new NanakoParser();
                const program = parser.parse(code);
                
                // JavaScriptã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                const jsCode = program.emit('js');
                document.getElementById('javascript-output').value = jsCode;
                
                // Pythonã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                const pyCode = program.emit('py');
                document.getElementById('python-output').value = pyCode;
                
            } catch (error) {
                const errorMsg = `# ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`;
                document.getElementById('javascript-output').value = errorMsg;
                document.getElementById('python-output').value = errorMsg;
            }
        }
        
        function clearOutput() {
            const output = document.getElementById('output');
            output.innerHTML = 'ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
            
            // ã‚¨ãƒ©ãƒ¼ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢
            clearErrorHighlight();
        }

        function initTheme() {
            // ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ¼ãƒã‚’èª­ã¿è¾¼ã‚€ã€ãªã‘ã‚Œã°ãƒ€ãƒ¼ã‚¯
            const savedTheme = localStorage.getItem('nanako-theme') || 'dark';
            setTheme(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        function setTheme(theme) {
            const themeBtn = document.getElementById('themeBtn');
            
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                if (themeBtn) themeBtn.textContent = 'ğŸŒ';
            } else {
                document.documentElement.removeAttribute('data-theme');
                if (themeBtn) themeBtn.textContent = 'ğŸŒ™';
            }
            
            // Monaco Editorã®ãƒ†ãƒ¼ãƒã‚‚æ›´æ–°
            updateMonacoTheme(theme);
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚æ›´æ–°
            updateFallbackEditorTheme(theme);
            
            // ãƒ†ãƒ¼ãƒã‚’ä¿å­˜
            localStorage.setItem('nanako-theme', theme);
        }

        function updateMonacoTheme(theme) {
            if (editor && editor.updateOptions) {
                try {
                    if (theme === 'light') {
                        monaco.editor.setTheme('vs');
                    } else {
                        monaco.editor.setTheme('nanako-dark');
                    }
                } catch (e) {
                    console.log('Monaco theme update failed:', e);
                }
            }
        }

        function updateFallbackEditorTheme(theme) {
            const textarea = document.getElementById('fallback-editor');
            if (textarea) {
                if (theme === 'light') {
                    textarea.style.background = '#ffffff';
                    textarea.style.color = '#333333';
                } else {
                    textarea.style.background = '#1e1e1e';
                    textarea.style.color = '#d4d4d4';
                }
            }
        }
        
        // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹é–¢æ•°
        function highlightErrorInEditor(line, col, message) {
            if (!editor) return;
            
            try {
                if (editor.getModel) {
                    // Monaco Editor ã®å ´åˆ
                    const model = editor.getModel();
                    if (model) {
                        // ã‚¨ãƒ©ãƒ¼ãƒãƒ¼ã‚«ãƒ¼ã‚’è¨­å®š
                        monaco.editor.setModelMarkers(model, 'nanako-error', [{
                            startLineNumber: line,
                            startColumn: Math.max(1, col - 1),
                            endLineNumber: line,
                            endColumn: col + 10, // ã‚¨ãƒ©ãƒ¼ç¯„å›²ã‚’å°‘ã—åºƒã‚ã«
                            message: message,
                            severity: monaco.MarkerSeverity.Error
                        }]);
                        
                        // ã‚¨ãƒ©ãƒ¼è¡Œã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç§»å‹•
                        editor.setPosition({ lineNumber: line, column: col });
                        editor.revealLineInCenter(line);
                    }
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®å ´åˆ
                    const textarea = document.getElementById('fallback-editor');
                    if (textarea) {
                        // è¡Œæ•°ã‚’è¨ˆç®—ã—ã¦ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç§»å‹•
                        const lines = textarea.value.split('\n');
                        let charPos = 0;
                        for (let i = 0; i < line - 1 && i < lines.length; i++) {
                            charPos += lines[i].length + 1; // +1 for newline
                        }
                        charPos += Math.max(0, col - 1);
                        
                        textarea.focus();
                        textarea.setSelectionRange(charPos, charPos + 10);
                    }
                }
            } catch (e) {
                console.error('Error highlighting failed:', e);
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢
        function clearErrorHighlight() {
            if (!editor) return;
            
            try {
                if (editor.getModel) {
                    // Monaco Editor ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                    const model = editor.getModel();
                    if (model) {
                        monaco.editor.setModelMarkers(model, 'nanako-error', []);
                    }
                }
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®å ´åˆã¯ç‰¹ã«ä½•ã‚‚ã—ãªã„
            } catch (e) {
                console.error('Error clearing highlight failed:', e);
            }
        }
        
        // ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½
        const resizeHandle = document.getElementById('resizeHandle');
        const outputContainer = document.getElementById('outputContainer');
        
        resizeHandle.addEventListener('mousedown', function(e) {
            isResizing = true;
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault();
        });
        
        function handleResize(e) {
            if (!isResizing) return;
            const containerRect = document.querySelector('.main-content').getBoundingClientRect();
            const newWidth = containerRect.right - e.clientX;
            const minWidth = 200;
            const maxWidth = containerRect.width - 200;
            
            if (newWidth >= minWidth && newWidth <= maxWidth) {
                outputContainer.style.width = newWidth + 'px';
            }
        }
        
        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚µã‚¤ã‚ºèª¿æ•´
        window.addEventListener('resize', function() {
            if (editor) {
                editor.layout();
            }
        });
    </script>
</body>
</html>