<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nanako (ãªãªã“) Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f5;
            transition: background 0.3s;
        }

        body.dark {
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .header {
            background: #2d2d30;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 300;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007acc;
            color: white;
        }

        .btn-primary:hover {
            background: #005a9e;
        }

        .btn-secondary {
            background: #5a5a5a;
            color: white;
        }

        .btn-secondary:hover {
            background: #6a6a6a;
        }

        .theme-toggle {
            background: #444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .editor-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
        }

        body.dark .editor-panel {
            border-right-color: #3e3e3e;
        }

        .editor-toolbar {
            background: #f8f8f8;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        body.dark .editor-toolbar {
            background: #2d2d30;
            border-bottom-color: #3e3e3e;
        }

        .example-select {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            font-size: 14px;
        }

        body.dark .example-select {
            background: #3c3c3c;
            color: #d4d4d4;
            border-color: #555;
        }

        .editor-container {
            flex: 1;
            position: relative;
        }

        #editor {
            width: 100%;
            height: 100%;
        }

        .output-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            background: white;
        }

        body.dark .output-panel {
            background: #252526;
        }

        .output-tabs {
            display: flex;
            background: #f8f8f8;
            border-bottom: 1px solid #ddd;
        }

        body.dark .output-tabs {
            background: #2d2d30;
            border-bottom-color: #3e3e3e;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            font-size: 14px;
        }

        .tab:hover {
            background: rgba(0,0,0,0.05);
        }

        body.dark .tab:hover {
            background: rgba(255,255,255,0.05);
        }

        .tab.active {
            border-bottom-color: #007acc;
            background: white;
        }

        body.dark .tab.active {
            background: #252526;
        }

        .tab-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .output-content {
            color: #333;
        }

        body.dark .output-content {
            color: #d4d4d4;
        }

        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 10px;
            border-left: 4px solid #e74c3c;
            margin: 10px 0;
            border-radius: 4px;
        }

        body.dark .error {
            background: #2d1b1b;
            color: #ff6b6b;
        }

        .stats {
            color: #666;
            font-size: 13px;
            margin-top: 10px;
        }

        body.dark .stats {
            color: #999;
        }

        .json-output {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e1e1e1;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            color: #333;
        }

        body.dark .json-output {
            background: #1e1e1e;
            border-color: #3e3e3e;
            color: #d4d4d4;
        }

        .print-output {
            border-left: 3px solid #007acc;
            padding-left: 10px;
            margin: 8px 0;
            color: #2c3e50;
        }

        body.dark .print-output {
            color: #a8c8e6;
        }

        .loading {
            display: none;
            color: #666;
            font-style: italic;
        }

        body.dark .loading {
            color: #999;
        }

        .resizer {
            width: 4px;
            background: #ddd;
            cursor: col-resize;
            position: relative;
            z-index: 10;
        }

        body.dark .resizer {
            background: #3e3e3e;
        }

        .resizer:hover {
            background: #007acc;
        }

        .fallback-editor {
            width: 100%;
            height: 100%;
            border: none;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            background: white;
            color: #333;
        }

        body.dark .fallback-editor {
            background: #1e1e1e;
            color: #d4d4d4;
        }

        /* Error highlighting styles */
        .error-line {
            background-color: rgba(255, 0, 0, 0.1);
            border-left: 4px solid #e74c3c;
        }

        body.dark .error-line {
            background-color: rgba(255, 0, 0, 0.2);
        }

        .error-glyph {
            background-color: #e74c3c;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            margin-left: 4px;
            margin-top: 2px;
        }

        .error-glyph::after {
            content: "!";
            color: white;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .editor-panel, .output-panel {
                width: 100%;
                height: 50%;
            }
            
            .resizer {
                width: 100%;
                height: 4px;
                cursor: row-resize;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Nanako (ãªãªã“) Editor</h1>
            <span id="version-display" style="font-size: 0.8em; color: #999; margin-left: 10px;"></span>
        </div>
        <div class="header-controls">
            <button class="btn btn-primary" onclick="executeCode()">å®Ÿè¡Œ (Ctrl+Enter)</button>
            <button class="btn btn-secondary" onclick="clearOutput()">ã‚¯ãƒªã‚¢</button>
            <button class="btn btn-secondary" onclick="downloadHistory()">è¨˜éŒ²ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>
        </div>
    </div>

    <div class="main-container">
        <div class="editor-panel">
            <div class="editor-toolbar">
                <label for="examples">ä¾‹ï¼š</label>
                <select id="examples" class="example-select" onchange="loadExample()">
                    <option value="">-- ä¾‹ã‚’é¸æŠ --</option>
                    <option value="basic">åŸºæœ¬æ“ä½œ</option>
                    <option value="loop">ãã‚Šè¿”ã—</option>
                    <option value="function">é–¢æ•°å®šç¾©</option>
                    <option value="gcd">æœ€å¤§å…¬ç´„æ•°</option>
                    <option value="array">é…åˆ—æ“ä½œ</option>
                    <option value="recursive">å†å¸°é–¢æ•°</option>
                    <option value="bubblesort">ãƒãƒ–ãƒ«ã‚½ãƒ¼ãƒˆ</option>
                    <option value="quicksort">ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆ</option>
                    <option value="lifegame">ãƒ©ã‚¤ãƒ•ã‚²ãƒ¼ãƒ </option>
                    <option value="rot13">ROT13æš—å·</option>
                </select>
                <span style="margin-left: 10px; color: #666; font-size: 12px;">
                    Ctrl+Enter ã§å®Ÿè¡Œ
                </span>
            </div>
            <div class="editor-container">
                <div id="editor"></div>
                <textarea id="fallback-editor" class="fallback-editor" style="display: none;" placeholder="Nanako ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            </div>
        </div>

        <div class="resizer" id="resizer"></div>

        <div class="output-panel">
            <div class="output-tabs">
                <div class="tab active" onclick="switchTab('output')">å‡ºåŠ›</div>
                <div class="tab" onclick="switchTab('javascript')">JavaScript</div>
                <div class="tab" onclick="switchTab('python')">Python</div>
            </div>
            <div class="tab-content">
                <div id="output-content" class="output-content">
                    <div style="color: #666; font-style: italic;">
                        ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã¨çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
                <div class="loading" id="loading">å®Ÿè¡Œä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script src="nanako.js"></script>
    <script>
        let monacoEditor = null;
        let currentTab = 'output';
        let isDarkTheme = false;
        let runtime = null;
        let outputs = [];
        let errorDecorations = [];
        let lastExecutedCode = '';
        let lastExecutionResult = null;
        let executionHistory = []; // ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°æ¼”ç¿’ã®è¨˜éŒ²

        const examples = {
            basic: `# åŸºæœ¬çš„ãªæ“ä½œ
x = 10
y = 5

# å¢—ã‚„ã™ãƒ»æ¸›ã‚‰ã™
xã‚’å¢—ã‚„ã™
yã‚’æ¸›ã‚‰ã™

x
y`,

            array: `# é…åˆ—ã®æ“ä½œ
æ•°åˆ— = [1, 2, 3, 4, 5]
æ–‡å­—åˆ— = "Hello"

# é…åˆ—ã®è¦ç´ ã‚’å–å¾—
æ•°åˆ—[0]
æ•°åˆ—[2]

# æ–‡å­—åˆ—ã¯æ–‡å­—ã‚³ãƒ¼ãƒ‰ã®é…åˆ—
æ–‡å­—åˆ—[0]
æ–‡å­—åˆ—[1]

# é…åˆ—ã®é•·ã•
|æ•°åˆ—|
|æ–‡å­—åˆ—|`,

            function: `# é–¢æ•°å®šç¾©ã®ä¾‹
è¶³ã—ç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’å¢—ã‚„ã™
    }
    XãŒç­”ãˆ
}

# çµ¶å¯¾å€¤é–¢æ•°
çµ¶å¯¾å€¤ = å…¥åŠ› X ã«å¯¾ã— {
    ã‚‚ã—XãŒ0ã‚ˆã‚Šå°ã•ã„ãªã‚‰ã°ã€{
        -XãŒç­”ãˆ
    }
    ãã†ã§ãªã‘ã‚Œã° {
        XãŒç­”ãˆ
    }
}

# é–¢æ•°ã‚’å‘¼ã³å‡ºã—
result1 = è¶³ã—ç®—(3, 4)
result2 = çµ¶å¯¾å€¤(-5)

result1
result2`,

            loop: `# ãƒ«ãƒ¼ãƒ—å‡¦ç†
count = 0

# 5å›ç¹°ã‚Šè¿”ã™
5å›ã€ãã‚Šè¿”ã™ {
    countã‚’å¢—ã‚„ã™
}

count

# é…åˆ—ã®å„è¦ç´ ã‚’å‡¦ç†
numbers = [10, 20, 30]
sum = 0
i = 0

|numbers|å›ã€ãã‚Šè¿”ã™ {
    sum = è¶³ã—ç®—(sum, numbers[i])
    iã‚’å¢—ã‚„ã™
}

è¶³ã—ç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’å¢—ã‚„ã™
    }
    XãŒç­”ãˆ
}

sum`,

            recursive: `# å†å¸°é–¢æ•°ã«ã‚ˆã‚‹éšä¹—
éšä¹— = å…¥åŠ› n ã«å¯¾ã— {
    ã‚‚ã— n ãŒ 1 ä»¥ä¸‹ãªã‚‰ã°ã€{
        1ãŒç­”ãˆ
    }
    ãã†ã§ãªã‘ã‚Œã°ã€{
        æ›ã‘ç®—(n, éšä¹—(æ¸›ã‚‰ã™(n)))ãŒç­”ãˆ
    }
}

æ›ã‘ç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    result = 0
    Yå›ã€ãã‚Šè¿”ã™ {
        result = è¶³ã—ç®—(result, X)
    }
    resultãŒç­”ãˆ
}

è¶³ã—ç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’å¢—ã‚„ã™
    }
    XãŒç­”ãˆ
}

æ¸›ã‚‰ã™ = å…¥åŠ› X ã«å¯¾ã— {
    Xã‚’æ¸›ã‚‰ã™
    XãŒç­”ãˆ
}

# 5ã®éšä¹—ã‚’è¨ˆç®—
result = éšä¹—(5)
result`,

            gcd: `# ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰äº’é™¤æ³•ã«ã‚ˆã‚‹æœ€å¤§å…¬ç´„æ•°
æœ€å¤§å…¬ç´„æ•° = å…¥åŠ› a, b ã«å¯¾ã— {
    ã‚‚ã— b ãŒ 0 ãªã‚‰ã°ã€{
        aãŒç­”ãˆ
    }
    ãã†ã§ãªã‘ã‚Œã°ã€{
        æœ€å¤§å…¬ç´„æ•°(b, ã‚ã¾ã‚Š(a, b))ãŒç­”ãˆ
    }
}

ã‚ã¾ã‚Š = å…¥åŠ› X, Y ã«å¯¾ã— {
    ã‚‚ã— X ãŒ Y ã‚ˆã‚Šå°ã•ã„ãªã‚‰ã°ã€{
        XãŒç­”ãˆ
    }
    ãã†ã§ãªã‘ã‚Œã°ã€{
        ã‚ã¾ã‚Š(å¼•ãç®—(X, Y), Y)ãŒç­”ãˆ
    }
}

å¼•ãç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’æ¸›ã‚‰ã™
    }
    XãŒç­”ãˆ
}

# 60ã¨48ã®æœ€å¤§å…¬ç´„æ•°
result = æœ€å¤§å…¬ç´„æ•°(60, 48)
result`,

            bubblesort: `# ãƒãƒ–ãƒ«ã‚½ãƒ¼ãƒˆ
# é…åˆ—ã‚’ã‚½ãƒ¼ãƒˆã™ã‚‹é–¢æ•°
ãƒãƒ–ãƒ«ã‚½ãƒ¼ãƒˆ = å…¥åŠ› é…åˆ— ã«å¯¾ã— {
    n = |é…åˆ—|
    
    # å¤–å´ãƒ«ãƒ¼ãƒ—: n-1å›ç¹°ã‚Šè¿”ã—
    å¼•ãç®—(n, 1)å›ã€ãã‚Šè¿”ã™ {
        äº¤æ›ãƒ•ãƒ©ã‚° = 0
        i = 0
        
        # å†…å´ãƒ«ãƒ¼ãƒ—: éš£æ¥è¦ç´ ã‚’æ¯”è¼ƒ
        å¼•ãç®—(n, 1)å›ã€ãã‚Šè¿”ã™ {
            ã‚‚ã— é…åˆ—[i] ãŒ é…åˆ—[è¶³ã—ç®—(i, 1)] ã‚ˆã‚Šå¤§ãã„ ãªã‚‰ã°ã€{
                # è¦ç´ ã‚’äº¤æ›
                temp = é…åˆ—[i]
                é…åˆ—[i] = é…åˆ—[è¶³ã—ç®—(i, 1)]
                é…åˆ—[è¶³ã—ç®—(i, 1)] = temp
                äº¤æ›ãƒ•ãƒ©ã‚° = 1
            }
            iã‚’å¢—ã‚„ã™
        }
        
        # äº¤æ›ãŒãªã‹ã£ãŸå ´åˆã¯å®Œäº†
        ã‚‚ã— äº¤æ›ãƒ•ãƒ©ã‚° ãŒ 0 ãªã‚‰ã°ã€{
            # æ—©æœŸçµ‚äº†ï¼ˆæœ€é©åŒ–ï¼‰
        }
    }
    
    é…åˆ—ãŒç­”ãˆ
}

# å¿…è¦ãªè£œåŠ©é–¢æ•°
è¶³ã—ç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’å¢—ã‚„ã™
    }
    XãŒç­”ãˆ
}

å¼•ãç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’æ¸›ã‚‰ã™
    }
    XãŒç­”ãˆ
}

# ã‚½ãƒ¼ãƒˆã™ã‚‹é…åˆ—
æ•°åˆ— = [64, 34, 25, 12, 22, 11, 90]

# ã‚½ãƒ¼ãƒˆå‰
æ•°åˆ—

# ãƒãƒ–ãƒ«ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
ã‚½ãƒ¼ãƒˆæ¸ˆã¿ = ãƒãƒ–ãƒ«ã‚½ãƒ¼ãƒˆ(æ•°åˆ—)

# ã‚½ãƒ¼ãƒˆå¾Œ
ã‚½ãƒ¼ãƒˆæ¸ˆã¿`,

            quicksort: `# ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆï¼ˆå†å¸°ç‰ˆï¼‰
# é…åˆ—ã®ä¸€éƒ¨ã‚’ã‚½ãƒ¼ãƒˆã™ã‚‹é–¢æ•°
ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆ = å…¥åŠ› é…åˆ—, é–‹å§‹, çµ‚äº† ã«å¯¾ã— {
    ã‚‚ã— é–‹å§‹ ãŒ çµ‚äº† ã‚ˆã‚Šå°ã•ã„ ãªã‚‰ã°ã€{
        # ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æ“ä½œ
        å¢ƒç•Œ = ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³(é…åˆ—, é–‹å§‹, çµ‚äº†)
        
        # å·¦å´ã‚’å†å¸°çš„ã«ã‚½ãƒ¼ãƒˆ
        ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆ(é…åˆ—, é–‹å§‹, å¼•ãç®—(å¢ƒç•Œ, 1))
        
        # å³å´ã‚’å†å¸°çš„ã«ã‚½ãƒ¼ãƒˆ
        ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆ(é…åˆ—, è¶³ã—ç®—(å¢ƒç•Œ, 1), çµ‚äº†)
    }
    é…åˆ—ãŒç­”ãˆ
}

# ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æ“ä½œï¼ˆãƒ”ãƒœãƒƒãƒˆã‚ˆã‚Šå°ã•ã„è¦ç´ ã‚’å·¦ã«ç§»å‹•ï¼‰
ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ = å…¥åŠ› é…åˆ—, é–‹å§‹, çµ‚äº† ã«å¯¾ã— {
    # æœ€å¾Œã®è¦ç´ ã‚’ãƒ”ãƒœãƒƒãƒˆã¨ã™ã‚‹
    ãƒ”ãƒœãƒƒãƒˆ = é…åˆ—[çµ‚äº†]
    i = é–‹å§‹
    j = é–‹å§‹
    
    # j ã‹ã‚‰ çµ‚äº†-1 ã¾ã§å‡¦ç†
    å¼•ãç®—(çµ‚äº†, é–‹å§‹)å›ã€ãã‚Šè¿”ã™ {
        ã‚‚ã— é…åˆ—[j] ãŒ ãƒ”ãƒœãƒƒãƒˆ ã‚ˆã‚Šå°ã•ã„ ãªã‚‰ã°ã€{
            # è¦ç´ ã‚’äº¤æ›
            temp = é…åˆ—[i]
            é…åˆ—[i] = é…åˆ—[j]
            é…åˆ—[j] = temp
            iã‚’å¢—ã‚„ã™
        }
        jã‚’å¢—ã‚„ã™
    }
    
    # ãƒ”ãƒœãƒƒãƒˆã‚’æ­£ã—ã„ä½ç½®ã«é…ç½®
    temp = é…åˆ—[i]
    é…åˆ—[i] = é…åˆ—[çµ‚äº†]
    é…åˆ—[çµ‚äº†] = temp
    
    iãŒç­”ãˆ
}

# é…åˆ—å…¨ä½“ã‚’ã‚½ãƒ¼ãƒˆã™ã‚‹ä¾¿åˆ©é–¢æ•°
é…åˆ—ã‚½ãƒ¼ãƒˆ = å…¥åŠ› é…åˆ— ã«å¯¾ã— {
    é•·ã• = |é…åˆ—|
    ã‚‚ã— é•·ã• ãŒ 1 ã‚ˆã‚Šå¤§ãã„ ãªã‚‰ã°ã€{
        ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆ(é…åˆ—, 0, å¼•ãç®—(é•·ã•, 1))
    }
    é…åˆ—ãŒç­”ãˆ
}

# å¿…è¦ãªè£œåŠ©é–¢æ•°
è¶³ã—ç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’å¢—ã‚„ã™
    }
    XãŒç­”ãˆ
}

å¼•ãç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’æ¸›ã‚‰ã™
    }
    XãŒç­”ãˆ
}

# ã‚½ãƒ¼ãƒˆã™ã‚‹é…åˆ—
æ•°åˆ— = [38, 27, 43, 3, 9, 82, 10]

# ã‚½ãƒ¼ãƒˆå‰
æ•°åˆ—

# ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
ã‚½ãƒ¼ãƒˆæ¸ˆã¿ = é…åˆ—ã‚½ãƒ¼ãƒˆ(æ•°åˆ—)

# ã‚½ãƒ¼ãƒˆå¾Œ
ã‚½ãƒ¼ãƒˆæ¸ˆã¿`,

            lifegame: `# Conway's Life Game (ãƒ©ã‚¤ãƒ•ã‚²ãƒ¼ãƒ )
# 5x5ã®ã‚°ãƒªãƒƒãƒ‰ã§3ä¸–ä»£å®Ÿè¡Œ

# ã‚»ãƒ«ã®çŠ¶æ…‹ã‚’å–å¾—ï¼ˆå¢ƒç•Œå¤–ã¯0ï¼‰
ã‚»ãƒ«å–å¾— = å…¥åŠ› ç›¤é¢, è¡Œ, åˆ— ã«å¯¾ã— {
    ã‚‚ã— è¡Œ ãŒ 0 ã‚ˆã‚Šå°ã•ã„ ãªã‚‰ã°ã€{
        0ãŒç­”ãˆ
    }
    ã‚‚ã— åˆ— ãŒ 0 ã‚ˆã‚Šå°ã•ã„ ãªã‚‰ã°ã€{
        0ãŒç­”ãˆ
    }
    ã‚‚ã— è¡Œ ãŒ 5 ä»¥ä¸Š ãªã‚‰ã°ã€{
        0ãŒç­”ãˆ
    }
    ã‚‚ã— åˆ— ãŒ 5 ä»¥ä¸Š ãªã‚‰ã°ã€{
        0ãŒç­”ãˆ
    }
    # 2æ¬¡å…ƒé…åˆ—ã‚¢ã‚¯ã‚»ã‚¹: board[row * 5 + col]
    ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ = è¶³ã—ç®—(æ›ã‘ç®—(è¡Œ, 5), åˆ—)
    ç›¤é¢[ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹]ãŒç­”ãˆ
}

# éš£æ¥ã™ã‚‹ç”Ÿãã¦ã„ã‚‹ã‚»ãƒ«ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
éš£æ¥ã‚«ã‚¦ãƒ³ãƒˆ = å…¥åŠ› ç›¤é¢, è¡Œ, åˆ— ã«å¯¾ã— {
    ã‚«ã‚¦ãƒ³ãƒˆ = 0
    
    # 8æ–¹å‘ã‚’ãƒã‚§ãƒƒã‚¯
    # ä¸Š
    ã‚«ã‚¦ãƒ³ãƒˆ = è¶³ã—ç®—(ã‚«ã‚¦ãƒ³ãƒˆ, ã‚»ãƒ«å–å¾—(ç›¤é¢, å¼•ãç®—(è¡Œ, 1), å¼•ãç®—(åˆ—, 1)))
    ã‚«ã‚¦ãƒ³ãƒˆ = è¶³ã—ç®—(ã‚«ã‚¦ãƒ³ãƒˆ, ã‚»ãƒ«å–å¾—(ç›¤é¢, å¼•ãç®—(è¡Œ, 1), åˆ—))
    ã‚«ã‚¦ãƒ³ãƒˆ = è¶³ã—ç®—(ã‚«ã‚¦ãƒ³ãƒˆ, ã‚»ãƒ«å–å¾—(ç›¤é¢, å¼•ãç®—(è¡Œ, 1), è¶³ã—ç®—(åˆ—, 1)))
    
    # å·¦å³
    ã‚«ã‚¦ãƒ³ãƒˆ = è¶³ã—ç®—(ã‚«ã‚¦ãƒ³ãƒˆ, ã‚»ãƒ«å–å¾—(ç›¤é¢, è¡Œ, å¼•ãç®—(åˆ—, 1)))
    ã‚«ã‚¦ãƒ³ãƒˆ = è¶³ã—ç®—(ã‚«ã‚¦ãƒ³ãƒˆ, ã‚»ãƒ«å–å¾—(ç›¤é¢, è¡Œ, è¶³ã—ç®—(åˆ—, 1)))
    
    # ä¸‹
    ã‚«ã‚¦ãƒ³ãƒˆ = è¶³ã—ç®—(ã‚«ã‚¦ãƒ³ãƒˆ, ã‚»ãƒ«å–å¾—(ç›¤é¢, è¶³ã—ç®—(è¡Œ, 1), å¼•ãç®—(åˆ—, 1)))
    ã‚«ã‚¦ãƒ³ãƒˆ = è¶³ã—ç®—(ã‚«ã‚¦ãƒ³ãƒˆ, ã‚»ãƒ«å–å¾—(ç›¤é¢, è¶³ã—ç®—(è¡Œ, 1), åˆ—))
    ã‚«ã‚¦ãƒ³ãƒˆ = è¶³ã—ç®—(ã‚«ã‚¦ãƒ³ãƒˆ, ã‚»ãƒ«å–å¾—(ç›¤é¢, è¶³ã—ç®—(è¡Œ, 1), è¶³ã—ç®—(åˆ—, 1)))
    
    ã‚«ã‚¦ãƒ³ãƒˆãŒç­”ãˆ
}

# æ¬¡ã®ä¸–ä»£ã‚’è¨ˆç®—
æ¬¡ä¸–ä»£è¨ˆç®— = å…¥åŠ› ç¾åœ¨ç›¤é¢ ã«å¯¾ã— {
    æ–°ç›¤é¢ = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    è¡Œ = 0
    
    5å›ã€ãã‚Šè¿”ã™ {
        åˆ— = 0
        5å›ã€ãã‚Šè¿”ã™ {
            ç¾åœ¨ã‚»ãƒ« = ã‚»ãƒ«å–å¾—(ç¾åœ¨ç›¤é¢, è¡Œ, åˆ—)
            éš£æ¥æ•° = éš£æ¥ã‚«ã‚¦ãƒ³ãƒˆ(ç¾åœ¨ç›¤é¢, è¡Œ, åˆ—)
            ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ = è¶³ã—ç®—(æ›ã‘ç®—(è¡Œ, 5), åˆ—)
            
            # ãƒ©ã‚¤ãƒ•ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«
            ã‚‚ã— ç¾åœ¨ã‚»ãƒ« ãŒ 1 ãªã‚‰ã°ã€{
                # ç”Ÿãã¦ã„ã‚‹ã‚»ãƒ«
                ã‚‚ã— éš£æ¥æ•° ãŒ 2 ãªã‚‰ã°ã€{
                    æ–°ç›¤é¢[ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹] = 1  # ç”Ÿå­˜
                }
                ã‚‚ã— éš£æ¥æ•° ãŒ 3 ãªã‚‰ã°ã€{
                    æ–°ç›¤é¢[ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹] = 1  # ç”Ÿå­˜
                }
            }
            ãã†ã§ãªã‘ã‚Œã°ã€{
                # æ­»ã‚“ã§ã„ã‚‹ã‚»ãƒ«
                ã‚‚ã— éš£æ¥æ•° ãŒ 3 ãªã‚‰ã°ã€{
                    æ–°ç›¤é¢[ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹] = 1  # èª•ç”Ÿ
                }
            }
            
            åˆ—ã‚’å¢—ã‚„ã™
        }
        è¡Œã‚’å¢—ã‚„ã™
    }
    
    æ–°ç›¤é¢ãŒç­”ãˆ
}

# å¿…è¦ãªè£œåŠ©é–¢æ•°
è¶³ã—ç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’å¢—ã‚„ã™
    }
    XãŒç­”ãˆ
}

å¼•ãç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’æ¸›ã‚‰ã™
    }
    XãŒç­”ãˆ
}

æ›ã‘ç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    çµæœ = 0
    Yå›ã€ãã‚Šè¿”ã™ {
        çµæœ = è¶³ã—ç®—(çµæœ, X)
    }
    çµæœãŒç­”ãˆ
}

# åˆæœŸãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚°ãƒ©ã‚¤ãƒ€ãƒ¼ï¼‰
# [0,0,0,0,0]  â–¡â–¡â–¡â–¡â–¡
# [0,1,0,0,0]  â–¡â– â–¡â–¡â–¡
# [0,0,1,1,0]  â–¡â–¡â– â– â–¡
# [0,1,1,0,0]  â–¡â– â– â–¡â–¡
# [0,0,0,0,0]  â–¡â–¡â–¡â–¡â–¡
ç›¤é¢0 = [0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0]

# å„ä¸–ä»£ã®çŠ¶æ…‹
ç›¤é¢0
ç›¤é¢1 = æ¬¡ä¸–ä»£è¨ˆç®—(ç›¤é¢0)
ç›¤é¢1
ç›¤é¢2 = æ¬¡ä¸–ä»£è¨ˆç®—(ç›¤é¢1)
ç›¤é¢2
ç›¤é¢3 = æ¬¡ä¸–ä»£è¨ˆç®—(ç›¤é¢2)
ç›¤é¢3`,

            rot13: `# ROT13 æš—å·åŒ–ãƒ»å¾©å·åŒ–
# ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‚’13æ–‡å­—ãšã‚‰ã™æš—å·

# æ–‡å­—ãŒå¤§æ–‡å­—ã®A-Zã‹ãƒã‚§ãƒƒã‚¯
å¤§æ–‡å­—åˆ¤å®š = å…¥åŠ› æ–‡å­—ã‚³ãƒ¼ãƒ‰ ã«å¯¾ã— {
    # A=65, Z=90
    ã‚‚ã— æ–‡å­—ã‚³ãƒ¼ãƒ‰ ãŒ 65 ä»¥ä¸Š ãªã‚‰ã°ã€{
        ã‚‚ã— æ–‡å­—ã‚³ãƒ¼ãƒ‰ ãŒ 90 ä»¥ä¸‹ ãªã‚‰ã°ã€{
            1ãŒç­”ãˆ
        }
    }
    0ãŒç­”ãˆ
}

# æ–‡å­—ãŒå°æ–‡å­—ã®a-zã‹ãƒã‚§ãƒƒã‚¯  
å°æ–‡å­—åˆ¤å®š = å…¥åŠ› æ–‡å­—ã‚³ãƒ¼ãƒ‰ ã«å¯¾ã— {
    # a=97, z=122
    ã‚‚ã— æ–‡å­—ã‚³ãƒ¼ãƒ‰ ãŒ 97 ä»¥ä¸Š ãªã‚‰ã°ã€{
        ã‚‚ã— æ–‡å­—ã‚³ãƒ¼ãƒ‰ ãŒ 122 ä»¥ä¸‹ ãªã‚‰ã°ã€{
            1ãŒç­”ãˆ
        }
    }
    0ãŒç­”ãˆ
}

# ROT13å¤‰æ›ï¼ˆ1æ–‡å­—ï¼‰
æ–‡å­—ROT13 = å…¥åŠ› æ–‡å­—ã‚³ãƒ¼ãƒ‰ ã«å¯¾ã— {
    ã‚‚ã— å¤§æ–‡å­—åˆ¤å®š(æ–‡å­—ã‚³ãƒ¼ãƒ‰) ãŒ 1 ãªã‚‰ã°ã€{
        # å¤§æ–‡å­—ã®å ´åˆï¼šA(65)ã‚’åŸºæº–ã«13ãšã‚‰ã™
        ç›¸å¯¾ä½ç½® = å¼•ãç®—(æ–‡å­—ã‚³ãƒ¼ãƒ‰, 65)
        æ–°ä½ç½® = ã‚ã¾ã‚Š(è¶³ã—ç®—(ç›¸å¯¾ä½ç½®, 13), 26)
        è¶³ã—ç®—(æ–°ä½ç½®, 65)ãŒç­”ãˆ
    }
    
    ã‚‚ã— å°æ–‡å­—åˆ¤å®š(æ–‡å­—ã‚³ãƒ¼ãƒ‰) ãŒ 1 ãªã‚‰ã°ã€{
        # å°æ–‡å­—ã®å ´åˆï¼ša(97)ã‚’åŸºæº–ã«13ãšã‚‰ã™
        ç›¸å¯¾ä½ç½® = å¼•ãç®—(æ–‡å­—ã‚³ãƒ¼ãƒ‰, 97)
        æ–°ä½ç½® = ã‚ã¾ã‚Š(è¶³ã—ç®—(ç›¸å¯¾ä½ç½®, 13), 26)
        è¶³ã—ç®—(æ–°ä½ç½®, 97)ãŒç­”ãˆ
    }
    
    # ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆä»¥å¤–ã¯ãã®ã¾ã¾
    æ–‡å­—ã‚³ãƒ¼ãƒ‰ãŒç­”ãˆ
}

# æ–‡å­—åˆ—å…¨ä½“ã‚’ROT13å¤‰æ›
æ–‡å­—åˆ—ROT13 = å…¥åŠ› æ–‡å­—åˆ— ã«å¯¾ã— {
    çµæœ = []
    i = 0
    é•·ã• = |æ–‡å­—åˆ—|
    
    é•·ã•å›ã€ãã‚Šè¿”ã™ {
        å…ƒæ–‡å­— = æ–‡å­—åˆ—[i]
        æ–°æ–‡å­— = æ–‡å­—ROT13(å…ƒæ–‡å­—)
        çµæœ[?] = æ–°æ–‡å­—
        iã‚’å¢—ã‚„ã™
    }
    
    çµæœãŒç­”ãˆ
}

# å‰°ä½™è¨ˆç®—ï¼ˆå‰²ã‚Šç®—ã®ä½™ã‚Šï¼‰
ã‚ã¾ã‚Š = å…¥åŠ› è¢«é™¤æ•°, é™¤æ•° ã«å¯¾ã— {
    ã‚‚ã— è¢«é™¤æ•° ãŒ é™¤æ•° ã‚ˆã‚Šå°ã•ã„ ãªã‚‰ã°ã€{
        è¢«é™¤æ•°ãŒç­”ãˆ
    }
    ã‚ã¾ã‚Š(å¼•ãç®—(è¢«é™¤æ•°, é™¤æ•°), é™¤æ•°)ãŒç­”ãˆ
}

# å¿…è¦ãªè£œåŠ©é–¢æ•°
è¶³ã—ç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’å¢—ã‚„ã™
    }
    XãŒç­”ãˆ
}

å¼•ãç®— = å…¥åŠ› X, Y ã«å¯¾ã— {
    Yå›ã€ãã‚Šè¿”ã™ {
        Xã‚’æ¸›ã‚‰ã™
    }
    XãŒç­”ãˆ
}

# ãƒ†ã‚¹ãƒˆç”¨ã®æ–‡å­—åˆ—
# "Hello World" ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰é…åˆ—
# H=72, e=101, l=108, l=108, o=111, (space)=32, W=87, o=111, r=114, l=108, d=100
å…ƒæ–‡å­—åˆ— = [72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100]

# æš—å·åŒ–
æš—å·åŒ–æ–‡å­—åˆ— = æ–‡å­—åˆ—ROT13(å…ƒæ–‡å­—åˆ—)

# å¾©å·åŒ–ï¼ˆROT13ã¯å¯¾ç§°ãªã®ã§2å›é©ç”¨ã§å…ƒã«æˆ»ã‚‹ï¼‰
å¾©å·åŒ–æ–‡å­—åˆ— = æ–‡å­—åˆ—ROT13(æš—å·åŒ–æ–‡å­—åˆ—)

# çµæœè¡¨ç¤º
å…ƒæ–‡å­—åˆ—
æš—å·åŒ–æ–‡å­—åˆ—
å¾©å·åŒ–æ–‡å­—åˆ—`
        };

        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            // Define Nanako language
            monaco.languages.register({ id: 'nanako' });
            
            monaco.languages.setMonarchTokensProvider('nanako', {
                tokenizer: {
                    root: [
                        [/#.*$/, 'comment'],
                        // Control flow keywords
                        [/\b(ã‚‚ã—|ãªã‚‰ã°|ãã†ã§ãªã‘ã‚Œã°|ãã‚Šè¿”ã™|å›)\b/, 'keyword.control'],
                        // Function keywords
                        [/\b(å…¥åŠ›|ã«å¯¾ã—|ãŒç­”ãˆ|ã‚’å®Ÿè¡Œ)\b/, 'keyword.function'],
                        // Variable operation keywords
                        [/\b(ã‚’|ã¨ã™ã‚‹|å¢—ã‚„ã™|æ¸›ã‚‰ã™|å‡ºåŠ›)\b/, 'keyword.operator'],
                        // Comparison operators
                        [/\b(ä»¥ä¸Š|ä»¥ä¸‹|ã‚ˆã‚Šå¤§ãã„|ã‚ˆã‚Šå°ã•ã„|ä»¥å¤–|æœªæº€)\b/, 'operator.comparison'],
                        // Numbers
                        [/\d+/, 'number'],
                        // Strings
                        [/"([^"\\]|\\.)*"/, 'string'],
                        // Identifiers (Japanese and ASCII)
                        [/[a-zA-Z_\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff][a-zA-Z0-9_\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff]*/, 'identifier'],
                        // Brackets and punctuation
                        [/[{}()\[\]]/, 'bracket'],
                        [/[=+\-*/ã€,]/, 'operator']
                    ]
                }
            });

            // Define custom color theme for Nanako
            monaco.editor.defineTheme('nanako-light', {
                base: 'vs',
                inherit: true,
                rules: [
                    { token: 'keyword.control', foreground: '0000FF', fontStyle: 'bold' },      // Blue for control flow
                    { token: 'keyword.function', foreground: 'FF6600', fontStyle: 'bold' },    // Orange for functions
                    { token: 'keyword.operator', foreground: 'CC0099', fontStyle: 'bold' },    // Purple for operations
                    { token: 'operator.comparison', foreground: '009900', fontStyle: 'bold' }, // Green for comparisons
                    { token: 'number', foreground: 'FF0000' },                                 // Red for numbers
                    { token: 'string', foreground: 'A31515' },                                 // Dark red for strings
                    { token: 'comment', foreground: '008000', fontStyle: 'italic' },           // Green italic for comments
                ],
                colors: {}
            });

            monaco.editor.defineTheme('nanako-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'keyword.control', foreground: '569CD6', fontStyle: 'bold' },      // Light blue for control flow
                    { token: 'keyword.function', foreground: 'FF9800', fontStyle: 'bold' },     // Orange for functions
                    { token: 'keyword.operator', foreground: 'E91E63', fontStyle: 'bold' },     // Pink for operations
                    { token: 'operator.comparison', foreground: '4CAF50', fontStyle: 'bold' },  // Green for comparisons
                    { token: 'number', foreground: 'F44336' },                                  // Red for numbers
                    { token: 'string', foreground: 'CE9178' },                                  // Light brown for strings
                    { token: 'comment', foreground: '6A9955', fontStyle: 'italic' },            // Green italic for comments
                ],
                colors: {}
            });

            monacoEditor = monaco.editor.create(document.getElementById('editor'), {
                value: '# Nanako (ãªãªã“) ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã“ã“ã«æ›¸ã„ã¦ãã ã•ã„\n# ä¾‹é¡Œã‚’é¸æŠã™ã‚‹ã‹ã€Ctrl+Enter ã§å®Ÿè¡Œã—ã¦ãã ã•ã„\n\nx = 42\nxã‚’å¢—ã‚„ã™\nx',
                language: 'nanako',
                theme: 'nanako-light',
                fontSize: 14,
                lineNumbers: 'on',
                roundedSelection: false,
                scrollBeyondLastLine: false,
                automaticLayout: true,
                minimap: { enabled: false },
                wordWrap: 'on'
            });

            // Add keyboard shortcut
            monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, function() {
                executeCode();
            });

            // Display version
            displayVersion();
        });

        // Fallback for when Monaco fails to load
        setTimeout(() => {
            if (!monacoEditor) {
                document.getElementById('editor').style.display = 'none';
                document.getElementById('fallback-editor').style.display = 'block';
                document.getElementById('fallback-editor').value = '# Nanako (ãªãªã“) ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã“ã“ã«æ›¸ã„ã¦ãã ã•ã„\n\nx = 42\nxã‚’å¢—ã‚„ã™\nx';
                displayVersion();
            }
        }, 3000);

        function getEditorValue() {
            if (monacoEditor) {
                return monacoEditor.getValue();
            } else {
                return document.getElementById('fallback-editor').value;
            }
        }

        function setEditorValue(value) {
            if (monacoEditor) {
                monacoEditor.setValue(value);
            } else {
                document.getElementById('fallback-editor').value = value;
            }
        }

        function displayVersion() {
            const versionDisplay = document.getElementById('version-display');
            if (versionDisplay && typeof NANAKO_VERSION !== 'undefined') {
                versionDisplay.textContent = `v${NANAKO_VERSION}`;
            }
        }

        function loadExample() {
            const select = document.getElementById('examples');
            const exampleKey = select.value;
            if (exampleKey && examples[exampleKey]) {
                setEditorValue(examples[exampleKey]);
                select.value = '';
                
                // Reset execution state since code changed
                lastExecutedCode = '';
                lastExecutionResult = null;
                clearErrorHighlights();
            }
        }

        function clearErrorHighlights() {
            if (monacoEditor && errorDecorations.length > 0) {
                errorDecorations = monacoEditor.deltaDecorations(errorDecorations, []);
            }
        }

        function highlightErrorLine(line, message) {
            if (monacoEditor) {
                const decorations = [{
                    range: new monaco.Range(line, 1, line, 1),
                    options: {
                        isWholeLine: true,
                        className: 'error-line',
                        glyphMarginClassName: 'error-glyph',
                        hoverMessage: { value: message },
                        minimap: {
                            color: '#ff0000',
                            position: monaco.editor.MinimapPosition.Inline
                        }
                    }
                }];
                errorDecorations = monacoEditor.deltaDecorations(errorDecorations, decorations);
            }
        }

        function parseErrorPosition(error, code) {
            // NanakoError has line/col properties set directly
            if (typeof error.line === 'number' && error.line > 0) {
                return {
                    line: error.line,
                    column: error.col || 1
                };
            }

            // Try error.details object
            if (error.details && typeof error.details.line === 'number') {
                return {
                    line: error.details.line,
                    column: error.details.col || 1
                };
            }

            // Try to extract line number from error message
            const lineMatch = error.message.match(/line (\d+)/i);
            if (lineMatch) {
                return {
                    line: parseInt(lineMatch[1]),
                    column: 1
                };
            }

            // If error has pos property, calculate line from position
            if (typeof error.pos === 'number') {
                const lines = code.substring(0, error.pos).split('\n');
                const line = lines.length;
                const column = lines[lines.length - 1].length + 1;
                return { line, column };
            }

            // Default fallback
            return { line: 1, column: 1 };
        }

        function executeCodeInternal(code, updateDisplay = true) {
            if (!code.trim()) {
                return null;
            }

            try {
                // Initialize runtime
                runtime = new NanakoRuntime();
                
                // Override print function to capture output
                const originalPrint = runtime.print;
                runtime.print = function(value, source, pos, endPos) {
                    const details = errorDetails(source, pos);
                    
                    // é…åˆ—ã®å ´åˆã¯ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆã—ã¦å‚ç…§ã®å•é¡Œã‚’å›é¿
                    let outputValue = value;
                    if (value instanceof NanakoArray) {
                        outputValue = new NanakoArray([...value.elements]);
                        outputValue.isStringView = value.isStringView;
                    }
                    
                    outputs.push({
                        type: 'print',
                        code: details.lineText.trim(),
                        value: outputValue
                    });
                };

                // Parse and execute
                const parser = new NanakoParser();
                const program = parser.parse(code);
                const env = {};
                
                runtime.start(10); // 10 second timeout
                program.evaluate(runtime, env);

                // Generate output
                let output = '';
                
                // 1. Print outputs
                if (outputs.length > 0) {
                    output += '=== å®Ÿè¡Œçµæœ ===\n';
                    outputs.forEach(item => {
                        output += `>>> ${item.code}\n`;
                        if (item.value instanceof NanakoArray) {
                            if (item.value.isStringView) {
                                const chars = item.value.elements.map(code => String.fromCharCode(code)).join('');
                                output += `"${chars}"\n`;
                            } else {
                                output += `${item.value.emit('js')}\n`;
                            }
                        } else {
                            output += `${item.value}\n`;
                        }
                        output += '\n';
                    });
                }

                // 2. Runtime statistics
                output += '=== çµ±è¨ˆæƒ…å ± ===\n';
                output += `ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆå›æ•°: ${runtime.incrementCount}\n`;
                output += `ãƒ‡ã‚¯ãƒªãƒ¡ãƒ³ãƒˆå›æ•°: ${runtime.decrementCount}\n`;
                output += `æ¯”è¼ƒå›æ•°: ${runtime.compareCount}\n\n`;

                // 3. JSON output
                output += '=== å¤‰æ•°ã®çŠ¶æ…‹ (JSON) ===\n';
                output += runtime.stringfyAsJson(env);

                // Generate code for other tabs
                let generatedJS, generatedPython;
                try {
                    generatedJS = program.emit('js', '');
                    generatedPython = program.emit('py', '');
                    console.log('Generated JS length:', generatedJS.length, 'chars');
                    console.log('Generated Python length:', generatedPython.length, 'chars');
                    if (generatedJS.length === 0) console.warn('JS code is empty!');
                    if (generatedPython.length === 0) console.warn('Python code is empty!');
                } catch (e) {
                    console.error('Code generation failed:', e);
                    generatedJS = '// ã‚³ãƒ¼ãƒ‰ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n' + e.message;
                    generatedPython = '# ã‚³ãƒ¼ãƒ‰ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n' + e.message;
                }

                const result = {
                    success: true,
                    output: output,
                    jsCode: generatedJS,
                    pyCode: generatedPython,
                    error: null
                };

                if (updateDisplay && currentTab === 'output') {
                    document.getElementById('output-content').innerHTML = `<div class="output-content">${escapeHtml(output)}</div>`;
                }

                return result;

            } catch (error) {
                // Parse error position and highlight the line
                const errorPos = parseErrorPosition(error, code);
                const errorMessage = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                const errorOutput = `${errorMessage}<br><small>è¡Œ ${errorPos.line}, åˆ— ${errorPos.column}</small>`;
                
                const result = {
                    success: false,
                    output: errorOutput,
                    jsCode: '// ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n' + errorMessage,
                    pyCode: '# ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n' + errorMessage,
                    error: error,
                    errorPos: errorPos,
                    errorMessage: errorMessage
                };

                if (updateDisplay) {
                    if (currentTab === 'output') {
                        document.getElementById('output-content').innerHTML = `<div class="error">${errorOutput}</div>`;
                    }
                    // Highlight error line in editor
                    highlightErrorLine(errorPos.line, errorMessage);
                }
                
                console.error('Execution error:', error);
                return result;
            }
        }

        function executeCode() {
            const code = getEditorValue();
            if (!code.trim()) {
                return;
            }

            // Clear output immediately when execution starts
            document.getElementById('output-content').innerHTML = '<div style="color: #666; font-style: italic;">å®Ÿè¡Œä¸­...</div>';
            
            // Reset execution state immediately
            lastExecutedCode = '';
            lastExecutionResult = null;
            window.generatedJS = '';
            window.generatedPython = '';
            
            const loadingEl = document.getElementById('loading');
            
            // Clear previous error highlights
            clearErrorHighlights();
            
            loadingEl.style.display = 'block';
            outputs = [];
            
            setTimeout(() => {
                lastExecutedCode = code;
                lastExecutionResult = executeCodeInternal(code, true);

                // Store global references for backward compatibility
                if (lastExecutionResult.success) {
                    window.generatedJS = lastExecutionResult.jsCode;
                    window.generatedPython = lastExecutionResult.pyCode;
                } else {
                    window.generatedJS = lastExecutionResult.jsCode;
                    window.generatedPython = lastExecutionResult.pyCode;
                }

                // å®Ÿè¡Œå±¥æ­´ã‚’è¨˜éŒ²
                recordExecution(code, lastExecutionResult);

                loadingEl.style.display = 'none';
            }, 100);
        }

        function clearOutput() {
            // Reset execution state
            lastExecutedCode = '';
            lastExecutionResult = null;
            outputs = [];
            window.generatedJS = '';
            window.generatedPython = '';

            // Clear error highlights
            clearErrorHighlights();

            // Reset display
            document.getElementById('output-content').innerHTML = '<div style="color: #666; font-style: italic;">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã¨çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>';

            // Switch to output tab
            if (currentTab !== 'output') {
                currentTab = 'output';
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.tab').classList.add('active');
            }
        }

        // å®Ÿè¡Œå±¥æ­´ã‚’è¨˜éŒ²ã™ã‚‹é–¢æ•°
        function recordExecution(code, result) {
            const timestamp = new Date();
            const record = {
                timestamp: timestamp,
                code: code,
                success: result.success,
                output: result.output,
                error: result.error || null
            };
            executionHistory.push(record);
        }

        // å®Ÿè¡Œå±¥æ­´ã‚’ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
        function downloadHistory() {
            if (executionHistory.length === 0) {
                alert('ã¾ã å®Ÿè¡Œå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰è¨˜éŒ²ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§å±¥æ­´ã‚’ã¾ã¨ã‚ã‚‹
            let text = '===================================\n';
            text += 'Nanako ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°æ¼”ç¿’è¨˜éŒ²\n';
            text += '===================================\n\n';

            executionHistory.forEach((record, index) => {
                const dateStr = record.timestamp.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                text += `--- å®Ÿè¡Œ ${index + 1} ---\n`;
                text += `æ—¥æ™‚: ${dateStr}\n`;
                text += `çŠ¶æ…‹: ${record.success ? 'æˆåŠŸ' : 'ã‚¨ãƒ©ãƒ¼'}\n\n`;
                text += `ã€ã‚³ãƒ¼ãƒ‰ã€‘\n`;
                text += record.code + '\n\n';

                if (record.success) {
                    text += `ã€å®Ÿè¡Œçµæœã€‘\n`;
                    text += record.output + '\n';
                } else {
                    text += `ã€ã‚¨ãƒ©ãƒ¼ã€‘\n`;
                    text += record.error + '\n';
                }

                text += '\n';
            });

            text += '===================================\n';
            text += `åˆè¨ˆå®Ÿè¡Œå›æ•°: ${executionHistory.length}\n`;
            text += '===================================\n';

            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆæ—¥ä»˜ã‚’å«ã‚€ï¼‰
            const now = new Date();
            const filename = `nanako_è¨˜éŒ²_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.txt`;

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function ensureCodeExecuted() {
            const currentCode = getEditorValue();
            
            // Check if code has changed since last execution
            if (currentCode !== lastExecutedCode || !lastExecutionResult) {
                // Re-execute the code
                outputs = [];
                clearErrorHighlights();
                
                const loadingEl = document.getElementById('loading');
                loadingEl.style.display = 'block';
                
                setTimeout(() => {
                    lastExecutedCode = currentCode;
                    lastExecutionResult = executeCodeInternal(currentCode, false);
                    
                    // Update current tab display
                    updateCurrentTabContent();
                    loadingEl.style.display = 'none';
                }, 50);
            } else {
                // Code hasn't changed, just update display
                updateCurrentTabContent();
            }
        }

        function updateCurrentTabContent() {
            const content = document.getElementById('output-content');
            
            if (!lastExecutionResult) {
                content.innerHTML = '<div style="color: #666; font-style: italic;">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã¨çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>';
                return;
            }

            if (currentTab === 'output') {
                if (lastExecutionResult.success) {
                    content.innerHTML = `<div class="output-content">${escapeHtml(lastExecutionResult.output)}</div>`;
                } else {
                    content.innerHTML = `<div class="error">${lastExecutionResult.output}</div>`;
                    if (lastExecutionResult.errorPos) {
                        highlightErrorLine(lastExecutionResult.errorPos.line, lastExecutionResult.errorMessage);
                    }
                }
            } else if (currentTab === 'javascript') {
                const jsCode = lastExecutionResult.jsCode || '// ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„';
                console.log('Displaying JS tab, code length:', jsCode.length);
                console.log('JS Code preview (first 200 chars):', jsCode.substring(0, 200));
                content.innerHTML = `<div class="json-output">${escapeHtml(jsCode)}</div>`;
            } else if (currentTab === 'python') {
                const pyCode = lastExecutionResult.pyCode || '# ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„';
                console.log('Displaying Python tab, code length:', pyCode.length);
                console.log('Python Code preview (first 200 chars):', pyCode.substring(0, 200));
                content.innerHTML = `<div class="json-output">${escapeHtml(pyCode)}</div>`;
            }

            // Update global variables for backward compatibility
            if (lastExecutionResult.success) {
                window.generatedJS = lastExecutionResult.jsCode;
                window.generatedPython = lastExecutionResult.pyCode;
            }
        }

        function switchTab(tab) {
            // Update tab appearance
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            currentTab = tab;
            
            // Ensure code is executed and synchronized with current editor content
            ensureCodeExecuted();
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.classList.toggle('dark');
            
            if (monacoEditor) {
                monaco.editor.setTheme(isDarkTheme ? 'nanako-dark' : 'nanako-light');
            }
            
            localStorage.setItem('nanako-theme', isDarkTheme ? 'dark' : 'light');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize resizer
        let isResizing = false;
        const resizer = document.getElementById('resizer');
        const editorPanel = document.querySelector('.editor-panel');
        const outputPanel = document.querySelector('.output-panel');

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
        });

        function handleResize(e) {
            if (!isResizing) return;
            
            const containerWidth = document.querySelector('.main-container').offsetWidth;
            const newLeftWidth = (e.clientX / containerWidth) * 100;
            
            if (newLeftWidth > 20 && newLeftWidth < 80) {
                editorPanel.style.width = newLeftWidth + '%';
                outputPanel.style.width = (100 - newLeftWidth) + '%';
            }
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }

        // Add keyboard shortcut for fallback editor
        document.getElementById('fallback-editor').addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                executeCode();
            }
        });

        // Load theme from localStorage
        const savedTheme = localStorage.getItem('nanako-theme');
        if (savedTheme === 'dark') {
            toggleTheme();
        }

        // Auto-execute on page load with delay
        setTimeout(() => {
            executeCode();
        }, 1000);
    </script>
</body>
</html>